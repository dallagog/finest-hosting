<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinEst, ver. 0.29 beta</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      position: relative;
    }

    .language-selector {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .language-selector select {
      padding: 8px 12px;
      border: 2px solid #007bff;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      outline: none;
      transition: 0.3s;
    }

    .language-selector select:hover {
      border-color: #0056b3;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      width: 320px;
      text-align: center;
    }

    .logo {
      width: 100px;
      margin-bottom: 15px;
    }

    h2 {
      margin-bottom: 30px;
    }

    .input-group {
      position: relative;
      margin-bottom: 25px;
      text-align: left;
    }

    .input-group i {
      position: absolute;
      top: 10px;
      left: 0;
      color: #555;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 10px 10px 10px 30px;
      border: none;
      border-bottom: 2px solid #ccc;
      outline: none;
      transition: 0.3s;
      box-sizing: border-box;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-bottom-color: #007bff;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      background: #007bff;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    .switch,
    .forgot {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      cursor: pointer;
    }

    .forgot:hover,
    .switch:hover {
      text-decoration: underline;
    }

    .offline {
      width: 300px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <!-- Selettore lingua in alto a destra -->
  <div class="language-selector">
    <label for="languageSelector" id="int.choose.language"></label>
    <select id="languageSelector">
      <option value="en_UK">ğŸ‡¬ğŸ‡§ English</option>
      <option value="it_IT">ğŸ‡®ğŸ‡¹ Italiano</option>
      <option value="de_DE">ğŸ‡©ğŸ‡ª Deutsch</option>
      <option value="fr_FR">ğŸ‡«ğŸ‡· FranÃ§ais</option>
      <option value="es_ES">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
      <option value="zh_CN">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
      <option value="ar_SA">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>
  </div>

  <div class="container" id="app-container">
    <img src="images/under_construction.jpeg" alt="Logo" class="logo">
    <h2 id="form-title">Login</h2>

    <div class="input-group">
      <i class="fa fa-user"></i>
      <input type="text" id="username" placeholder="Username">
    </div>
    <div class="input-group">
      <i class="fa fa-lock"></i>
      <input type="password" id="password" placeholder="Password">
    </div>

    <button id="submit-btn">Sign in</button>
    <div class="forgot" id="forgot-password">Forgot password? Reset password</div>
    <div class="switch" id="switch-form">Don't have an account? Sign up</div>
  </div>

  <script>
    const apiBaseNew = "https://new-user-tunnel.fe-web.eu";
    const apiBaseUser = "https://user-tunnel.fe-web.eu";

    let currentLang = 'it_IT';
    let translations = {};
    let isLogin = true;

    console.log("=== FinEst Login v0.24 - Debug Mode ===");
    console.log("Initial language:", currentLang);

    // Caricamento traduzioni dai file JSON
    async function loadTranslations(lang) {
      console.log("ğŸ“š Loading translations for:", lang);
      try {
        const response = await fetch(`lang/${lang}.json`);
        console.log("Translation fetch response:", response.status, response.ok);
        if (!response.ok) throw new Error((getTranslation("int.error.loading") || "Loading error:") + lang);
        translations = await response.json();
        console.log("âœ… Translations loaded successfully:", Object.keys(translations).length, "keys");
        updatePageTranslations();
      } catch (error) {
        console.error('âŒ Errore caricamento traduzioni:', error);
      }
    }

    function getTranslation(key) {
      const value = translations[key] || key;
      console.log(`ğŸ”¤ Translation [${key}]:`, value);
      return value;
    }

    function updatePageTranslations() {
      console.log("ğŸ”„ Updating page translations, isLogin:", isLogin);
      
      // Aggiorna titolo form
      const formTitle = document.getElementById('form-title');
      if (formTitle) {
        formTitle.textContent = isLogin ? getTranslation('int.login') : getTranslation('int.registration');
      }

      // Aggiorna placeholder
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      if (usernameInput) usernameInput.placeholder = getTranslation('int.username');
      if (passwordInput) passwordInput.placeholder = getTranslation('int.password');

      // Aggiorna bottone
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.textContent = isLogin ? getTranslation('int.signin') : getTranslation('int.create.account');
      }

      // Aggiorna link
      const forgotPassword = document.getElementById('forgot-password');
      const switchForm = document.getElementById('switch-form');
      if (forgotPassword) forgotPassword.textContent = getTranslation('int.forgot.password');
      if (switchForm) {
        switchForm.textContent = isLogin ? getTranslation('int.no.account') : getTranslation('int.have.account');
      }
    }

    // Cambio lingua
    document.getElementById('languageSelector').addEventListener('change', (e) => {
      console.log("ğŸŒ Language changed to:", e.target.value);
      currentLang = e.target.value;
      loadTranslations(currentLang);
    });

    // Carica lingua di default
    loadTranslations(currentLang);

    async function checkHealth() {
      console.log("ğŸ¥ Checking service health...");
      try {
        const resUser = await fetch(`${apiBaseUser}/health`, { cache: "no-cache" });
        const resNew = await fetch(`${apiBaseNew}/health`, { cache: "no-cache" });
        console.log("User service health:", resUser.status, resUser.ok);
        console.log("New user service health:", resNew.status, resNew.ok);
        
        if (!resUser.ok || !resNew.ok) throw new Error("HTTP error");
        
        const dataUser = await resUser.json();
        const dataNew = await resNew.json();
        console.log("User service data:", dataUser);
        console.log("New user service data:", dataNew);
        
        if (dataUser.status !== "ok" || dataNew.status !== "ok") throw new Error("Service not OK");
        console.log("âœ… All services are healthy");
      } catch (err) {
        console.error("âŒ Service check failed:", err);
        document.body.innerHTML = `
        <div style="display:flex;justify-content:center;align-items:center;height:100vh;">
          <img src="images/off-line.jpeg" alt="Offline" class="offline">
        </div>
      `;
      }
    }
    checkHealth();

    // === LOGIN / REGISTRAZIONE SWITCH ===
    const switchForm = document.getElementById("switch-form");

    switchForm.addEventListener("click", () => {
      isLogin = !isLogin;
      console.log("ğŸ”„ Switched form mode to:", isLogin ? "LOGIN" : "REGISTRATION");
      updatePageTranslations();
      document.getElementById("forgot-password").style.display = isLogin ? "block" : "none";
    });

    // === LOGIN / REGISTER ===
    document.getElementById('submit-btn').addEventListener("click", async () => {
      console.log("\n=== SUBMIT BUTTON CLICKED ===");
      console.log("Mode:", isLogin ? "LOGIN" : "REGISTRATION");
      
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      
      console.log("Username:", username);
      console.log("Password:", password ? "***" + password.slice(-2) : "(empty)");
      console.log("Current language:", currentLang);
      
      if (!username || !password) {
        console.warn("âš ï¸ Missing username or password");
        alert(getTranslation("int.complete.all.fields") || "Please fill in all fields");
        return;
      }

      const apiUrl = isLogin ? `${apiBaseUser}/login` : `${apiBaseNew}/create`;
      const payload = { username, password, language: currentLang };

      console.log("ğŸ“¤ API URL:", apiUrl);
      console.log("ğŸ“¤ Payload:", { username, password: "***", language: currentLang });

      try {
        console.log("ğŸŒ Sending fetch request...");
        console.log("ğŸ” Testing endpoint reachability first...");
        
        // Test preliminare: prova una semplice GET
        try {
          const testResponse = await fetch(apiUrl.replace('/login', '/health').replace('/create', '/health'), {
            method: "GET",
            mode: "cors"
          });
          console.log("âœ… Health check response:", testResponse.status);
        } catch (testErr) {
          console.error("âŒ Health check failed:", testErr.message);
          console.error("This suggests the server is not reachable or CORS is blocking");
        }
        
        console.log("ğŸ“¤ Now attempting actual request with mode and credentials...");
        const response = await fetch(apiUrl, {
          method: "POST",
          mode: "cors",
          credentials: "omit",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(payload)
        });

        console.log("ğŸ“¥ Response received:");
        console.log("  - Status:", response.status);
        console.log("  - Status Text:", response.statusText);
        console.log("  - OK:", response.ok);
        console.log("  - Headers:", [...response.headers.entries()]);

        const contentType = response.headers.get("content-type");
        console.log("  - Content-Type:", contentType);
        
        let data;
        if (contentType && contentType.includes("application/json")) {
          data = await response.json();
          console.log("ğŸ“„ Response data (JSON):", data);
        } else {
          data = await response.text();
          console.log("ğŸ“„ Response data (TEXT):", data);
        }

        if (response.ok) {
          console.log("âœ… Request successful");
          if (isLogin) {
            console.log("ğŸ” Processing login...");
            await loadTranslations(currentLang);
            
            if (data.info && (!data.info.email || !data.info.language || !data.info.currency)) {
              console.log("â„¹ï¸ Missing user info, requesting completion");
              requestMissingInfo(data.info, username, password);
            } else {
              console.log("âœ… User info complete, opening dashboard");
              openDashboard(username, data.token);
            }
          } else {
            console.log("âœ… Registration successful");
            alert(getTranslation('int.creation.success') || "Account created successfully! Please log in.");
            isLogin = true;
            updatePageTranslations();
            document.getElementById("username").value = username;
            document.getElementById("password").value = "";
          }
        } else {
          console.error("âŒ Request failed");
          if (isLogin) {
            console.error("Login failed with status:", response.status);
            alert(getTranslation('int.login.failed') || "Login failed");
          } else {
            console.error("Registration failed with status:", response.status);
            const errorMsg = getTranslation('int.creation.failed') || "Creation failed";
            const detailMsg = typeof data === 'object' ? (data.message || JSON.stringify(data)) : data;
            alert(errorMsg + "\n\nStatus: " + response.status + "\nDetails: " + detailMsg);
          }
        }
      } catch (err) {
        console.error("âŒ Exception caught:", err);
        console.error("Error name:", err.name);
        console.error("Error message:", err.message);
        console.error("Error stack:", err.stack);
        console.error("Full error object:", err);
        
        // Mostra anche nell'alert maggiori dettagli
        const errorDetails = `
Name: ${err.name}
Message: ${err.message}
Type: ${err.constructor.name}
        `.trim();
        
        alert((getTranslation('int.connection.error') || "Connection error:") + "\n\n" + errorDetails);
      }
    });

    // === FORGOT PASSWORD ===
    document.getElementById("forgot-password").addEventListener("click", () => {
      console.log("ğŸ”‘ Forgot password clicked");
      const email = prompt(getTranslation('int.enter.email') || "Enter your email to reset password:");
      console.log("Email entered:", email);
      if (!email) return;
      alert(getTranslation('int.reset.email.sent') || "If this email is registered, you will receive a password reset link.");
    });

    // === UPDATE INFO E RITORNO AL LOGIN ===
    function requestMissingInfo(info, username, password) {
      console.log("ğŸ“ Requesting missing info:", info);
      const container = document.getElementById("app-container");
      container.innerHTML = `
        <h2>${getTranslation('int.complete.profile')}</h2>
        <div class="input-group">
          <i class="fa fa-envelope"></i>
          <input type="email" id="email" placeholder="${getTranslation('int.email')}" value="${info.email || ''}">
        </div>
        <div class="input-group">
          <i class="fa fa-language"></i>
          <select id="language">
            <option value="">${getTranslation('int.select.language')}</option>
            <option value="en_UK" ${info.language === 'en_UK' ? 'selected' : ''}>English</option>
            <option value="it_IT" ${info.language === 'it_IT' ? 'selected' : ''}>Italiano</option>
            <option value="fr_FR" ${info.language === 'fr_FR' ? 'selected' : ''}>FranÃ§ais</option>
          </select>
        </div>
        <div class="input-group">
          <i class="fa fa-coins"></i>
          <select id="currency">
            <option value="">${getTranslation('int.select.currency')}</option>
            <option value="EUR" ${info.currency === 'EUR' ? 'selected' : ''}>EUR</option>
            <option value="USD" ${info.currency === 'USD' ? 'selected' : ''}>USD</option>
            <option value="GBP" ${info.currency === 'GBP' ? 'selected' : ''}>GBP</option>
          </select>
        </div>
        <button id="save-info">${getTranslation('int.update')}</button>
      `;

      document.getElementById("save-info").addEventListener("click", async () => {
        console.log("ğŸ’¾ Save info clicked");
        const email = document.getElementById("email").value.trim();
        const language = document.getElementById("language").value.trim();
        const currency = document.getElementById("currency").value.trim();

        console.log("Data to save:", { email, language, currency });

        if (!email || !language || !currency) {
          console.warn("âš ï¸ Incomplete fields");
          alert(getTranslation('int.complete.all.fields') || "Please complete all fields.");
          return;
        }

        try {
          console.log("ğŸ“¤ Sending update request...");
          const response = await fetch(`${apiBaseUser}/update`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password, email, language, currency })
          });

          console.log("Update response status:", response.status);
          const data = await response.json();
          console.log("Update response data:", data);

          if (response.ok && data.status === "ok") {
            console.log("âœ… Info saved successfully");
            alert(getTranslation('int.info.saved') || "Information saved successfully! Please log in again.");
            window.location.href = "index.html";
          } else {
            console.error("âŒ Update failed");
            alert((getTranslation("int.error.update") || "Update failed: ") + data.message);
          }
        } catch (err) {
          console.error("âŒ Error saving info:", err);
          alert((getTranslation("int.error.saving") || "Error saving info: ") + err.message);
        }
      });
    }

    function openDashboard(username, token) {
      console.log("ğŸšª Opening dashboard for user:", username);
      console.log("Token:", token ? "***" + token.slice(-10) : "(none)");
      localStorage.setItem("username", username);
      localStorage.setItem("token", token);
      localStorage.setItem("language", currentLang);
      console.log("âœ… Data saved to localStorage");
      window.location.href = "dashboard.html";
    }
  </script>
</body>

</html>