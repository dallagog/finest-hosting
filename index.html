<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinEst, ver. 0.9beta</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="/images/logo-bullandbear.png">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      width: 320px;
      text-align: center;
    }

    .logo {
      width: 100px;
      margin-bottom: 15px;
    }

    h2 {
      margin-bottom: 30px;
    }

    .input-group {
      position: relative;
      margin-bottom: 25px;
      text-align: left;
    }

    .input-group i {
      position: absolute;
      top: 10px;
      left: 0;
      color: #555;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 10px 10px 10px 30px;
      border: none;
      border-bottom: 2px solid #ccc;
      outline: none;
      transition: 0.3s;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-bottom-color: #007bff;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      background: #007bff;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    .switch,
    .forgot {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      cursor: pointer;
    }

    .forgot:hover,
    .switch:hover {
      text-decoration: underline;
    }

    /* === DASHBOARD === */
    .dashboard {
      display: flex;
      width: 100%;
      height: 100vh;
    }

    .sidebar {
      width: 220px;
      background: #1a1a1a;
      color: white;
      padding: 20px;
    }

    .sidebar h3 {
      text-align: center;
      margin-bottom: 20px;
    }

    .menu-item {
      margin-bottom: 15px;
    }

    .menu-item>div {
      cursor: pointer;
      padding: 8px;
      background: #333;
      border-radius: 5px;
    }

    .submenu {
      margin-top: 5px;
      margin-left: 10px;
      display: none;
    }

    .submenu div {
      background: #444;
      padding: 6px;
      border-radius: 5px;
      margin-top: 5px;
      cursor: pointer;
    }

    .submenu div:hover {
      background: #555;
    }

    .content {
      flex-grow: 1;
      padding: 20px;
      background: #f8f9fa;
    }

    /* === OFFLINE === */
    .offline {
      width: 300px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <div class="container" id="app-container">
    <img src="images/under_construction.jpeg" alt="Logo" class="logo">
    <h2 id="form-title">Login</h2>

    <div class="input-group">
      <i class="fa fa-user"></i>
      <input type="text" id="username" placeholder="Username">
    </div>
    <div class="input-group">
      <i class="fa fa-lock"></i>
      <input type="password" id="password" placeholder="Password">
    </div>

    <button id="submit-btn">Sign in</button>
    <div class="forgot" id="forgot-password">Forgot password?</div>
    <div class="switch" id="switch-form">Don‚Äôt have an account? Sign up</div>
  </div>

  <script>
    const apiBaseNew = "https://new-user-tunnel.fe-web.eu";
    const apiBaseUser = "https://user-tunnel.fe-web.eu";

    // === CHECK SERVIZIO HEALTH ===
    async function checkHealth() {
      try {
        const resUser = await fetch(`${apiBaseUser}/health`, { cache: "no-cache" });
        const resNew = await fetch(`${apiBaseNew}/health`, { cache: "no-cache" });
        if (!resUser.ok || !resNew.ok) throw new Error("HTTP error");
        const dataUser = await resUser.json();
        const dataNew = await resNew.json();
        if (dataUser.status !== "ok" || dataNew.status !== "ok") throw new Error("Service not OK");
      } catch (err) {
        document.body.innerHTML = `
        <div style="display:flex;justify-content:center;align-items:center;height:100vh;">
          <img src="images/off-line.jpeg" alt="Offline" class="offline">
        </div>
      `;
        console.error("Service check failed:", err);
      }
    }

    checkHealth();

    // === LOGIN / REGISTRAZIONE SWITCH ===
    let isLogin = true;
    const title = document.getElementById("form-title");
    const submitBtn = document.getElementById("submit-btn");
    const switchForm = document.getElementById("switch-form");

    switchForm.addEventListener("click", () => {
      isLogin = !isLogin;
      if (isLogin) {
        title.textContent = "Login";
        submitBtn.textContent = "Sign in";
        switchForm.textContent = "Don‚Äôt have an account? Sign up";
        document.getElementById("forgot-password").style.display = "block";
      } else {
        title.textContent = "Registration";
        submitBtn.textContent = "Create Account";
        switchForm.textContent = "Already have an account? Sign in";
        document.getElementById("forgot-password").style.display = "none";
      }
    });

    // === LOGIN / REGISTER ===
    submitBtn.addEventListener("click", async () => {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) {
        alert("Please fill in all fields");
        return;
      }

      const apiUrl = isLogin ? `${apiBaseUser}/login` : `${apiBaseNew}/create`;
      const payload = { username, password };

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        //const data = await response.json();

        let data;
        try {
          const contentType = response.headers.get("content-type");
          if (contentType && contentType.includes("application/json")) {
            data = await response.json();
          } else {
            const text = await response.text();
            throw new Error("Invalid JSON response: " + text);
          }
        } catch (parseErr) {
          alert("Server returned invalid JSON: " + parseErr.message);
          return;
        }

        alert(response)
        alert(data)

        if (response.ok && data.status === "ok") {
          if (isLogin) {
            if (data.info && (!data.info.email || !data.info.language || !data.info.currency)) {
              requestMissingInfo(data.info, username);
            } else {
              alert("Logged in!");
              openDashboard(username);
            }
          } else {
            alert("Account created!");
          }
        } else {
          alert(data.detail || "API error" || response);
        }

      } catch (err) {
        alert("Connection error: " + err);
      }
    });

    // === FORGOT PASSWORD ===
    document.getElementById("forgot-password").addEventListener("click", () => {
      const email = prompt("Enter your email to reset password:");
      if (!email) return;
      alert("If this email is registered, you will receive a password reset link.");
    });

    // === RICHIESTA CAMPI MANCANTI ===
    function requestMissingInfo(info, username) {
      const container = document.getElementById("app-container");
      container.innerHTML = `
      <h2>Complete your profile</h2>
      <div class="input-group">
        <i class="fa fa-envelope"></i>
        <input type="email" id="email" placeholder="Email" value="${info.email || ''}">
      </div>
      <div class="input-group">
        <i class="fa fa-language"></i>
        <select id="language">
          <option value="">Select language</option>
          <option value="en" ${info.language === 'en' ? 'selected' : ''}>English</option>
          <option value="it" ${info.language === 'it' ? 'selected' : ''}>Italiano</option>
          <option value="fr" ${info.language === 'fr' ? 'selected' : ''}>Fran√ßais</option>
        </select>
      </div>
      <div class="input-group">
        <i class="fa fa-coins"></i>
        <select id="currency">
          <option value="">Select currency</option>
          <option value="EUR" ${info.currency === 'EUR' ? 'selected' : ''}>EUR</option>
          <option value="USD" ${info.currency === 'USD' ? 'selected' : ''}>USD</option>
          <option value="GBP" ${info.currency === 'GBP' ? 'selected' : ''}>GBP</option>
        </select>
      </div>
      <button id="save-info">Save and Continue</button>
    `;

      document.getElementById("save-info").addEventListener("click", () => {
        const email = document.getElementById("email").value.trim();
        const language = document.getElementById("language").value.trim();
        const currency = document.getElementById("currency").value.trim();

        if (!email || !language || !currency) {
          alert("Please complete all fields.");
          return;
        }

        // qui si pu√≤ aggiungere una chiamata API per salvare i dati
        fetch(`${apiBaseUser}/update`, { method: "POST", body: JSON.stringify({ email, language, currency }) })

        alert("Information saved!");
        openDashboard(username);
      });
    }

    // === DASHBOARD ===
    function openDashboard(username) {
      document.body.innerHTML = `
      <div class="dashboard">
        <div class="sidebar">
          <h3>Welcome, ${username}</h3>
          <div class="menu-item">
            <div onclick="toggleSubmenu('settings-submenu')">‚öôÔ∏è Impostazioni</div>
            <div class="submenu" id="settings-submenu">
              <div onclick="showContent('Profilo')">Profilo</div>
              <div onclick="showContent('Sicurezza')">Sicurezza</div>
            </div>
          </div>
          <div class="menu-item">
            <div onclick="toggleSubmenu('wallet-submenu')">üí∞ Wallet</div>
            <div class="submenu" id="wallet-submenu">
              <div onclick="showContent('Saldo')">Saldo</div>
              <div onclick="showContent('Transazioni')">Transazioni</div>
            </div>
          </div>
        </div>
        <div class="content" id="dashboard-content">
          <h2>Dashboard</h2>
          <p>Benvenuto nella tua area riservata.</p>
        </div>
      </div>
    `;
    }

    // === FUNZIONI DASHBOARD ===
    window.toggleSubmenu = function (id) {
      const submenu = document.getElementById(id);
      submenu.style.display = submenu.style.display === "block" ? "none" : "block";
    };

    window.showContent = function (section) {
      const content = document.getElementById("dashboard-content");
      content.innerHTML = `<h2>${section}</h2><p>Contenuto della sezione "${section}".</p>`;
    };
  </script>
</body>

</html>