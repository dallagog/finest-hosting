<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinEst, ver. 0.40 beta</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      position: relative;
    }

    .language-selector {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    #languageCombo {
      padding: 8px 12px;
      border: 2px solid #007bff;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      outline: none;
      transition: 0.3s;
    }

    #languageCombo:hover {
      border-color: #0056b3;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }

    #languageCombo:focus {
      border-color: #0056b3;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      width: 320px;
      text-align: center;
    }

    .logo {
      width: 100px;
      margin-bottom: 15px;
    }

    h2 {
      margin-bottom: 30px;
    }

    .input-group {
      position: relative;
      margin-bottom: 25px;
      text-align: left;
    }

    .input-group i {
      position: absolute;
      top: 10px;
      left: 0;
      color: #555;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 10px 10px 10px 30px;
      border: none;
      border-bottom: 2px solid #ccc;
      outline: none;
      transition: 0.3s;
      box-sizing: border-box;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-bottom-color: #007bff;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      background: #007bff;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    .switch,
    .forgot {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      cursor: pointer;
    }

    .forgot:hover,
    .switch:hover {
      text-decoration: underline;
    }

    .offline {
      width: 300px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <div class="language-selector">
    <select id="languageCombo">
      <option value="">Loading...</option>
    </select>
  </div>

  <div class="container" id="app-container">
    <img src="images/under_construction.jpeg" alt="Logo" class="logo">
    <h2 id="form-title">Login</h2>

    <div class="input-group">
      <i class="fa fa-user"></i>
      <input type="text" id="username" placeholder="Username">
    </div>
    <div class="input-group">
      <i class="fa fa-lock"></i>
      <input type="password" id="password" placeholder="Password">
    </div>

    <button id="submit-btn">Sign in</button>
    <div class="forgot" id="forgot-password">Forgot password? Reset password</div>
    <div class="switch" id="switch-form">Don't have an account? Sign up</div>
  </div>

  <script>
    const apiBaseNew = "https://new-user-tunnel.fe-web.eu";
    const apiBaseUser = "https://user-tunnel.fe-web.eu";

    let language = 'en_UK'; // Lingua di default
    let translations = {};
    let currencies = [];
    let timezones = [];
    let availableLanguages = [];
    let isLogin = true;

    console.log("=== FinEst Login v0.31 ===");
    console.log("üåç Default language:", language);

    // ========== LANGUAGE SYSTEM ==========
    
    // Leggi l'elenco delle lingue dal manifest
    async function loadLanguageManifest() {
      console.log("üìã Loading language manifest...");
      try {
        const response = await fetch('lang/manifest.json');
        if (!response.ok) {
          console.error("Cannot load manifest.json");
          return [];
        }

        const manifest = await response.json();
        console.log("‚úÖ Manifest loaded:", manifest.languages);
        return manifest.languages || [];
      } catch (error) {
        console.error("Error loading manifest:", error);
        return [];
      }
    }

    // Carica un singolo file di lingua
    async function loadLanguageFile(langCode) {
      try {
        const response = await fetch(`lang/${langCode}.json`);
        if (!response.ok) {
          console.warn(`File not found: lang/${langCode}.json`);
          return null;
        }

        const data = await response.json();

        if (data['int.language.code'] && data['int.language.description'] && data['img.language.flag']) {
          return {
            code: data['int.language.code'],
            description: data['int.language.description'],
            flag: data['img.language.flag']
          };
        } else {
          console.warn(`Invalid structure in ${langCode}.json`);
          return null;
        }
      } catch (error) {
        console.error(`Error loading ${langCode}.json:`, error);
        return null;
      }
    }

    // Inizializza le lingue
    async function initializeLanguages() {
      console.log("üåç Initializing languages...");

      const langCodes = await loadLanguageManifest();

      for (const langCode of langCodes) {
        const langData = await loadLanguageFile(langCode);
        if (langData) {
          availableLanguages.push(langData);
          console.log(`‚úÖ Language loaded: ${langData.code}`);
        }
      }

      // Mantieni l'ordine dal manifest (non ordinare alfabeticamente)
      console.log("‚úÖ Languages initialized:", availableLanguages.length);
    }

    // Aggiorna combobox lingue
    function updateLanguageCombo() {
      const combo = document.getElementById('languageCombo');
      combo.innerHTML = '';

      if (availableLanguages.length === 0) {
        console.warn("No languages available");
        combo.innerHTML = '<option value="">No languages</option>';
        return;
      }

      availableLanguages.forEach(lang => {
        const option = document.createElement('option');
        option.value = lang.code;
        option.textContent = `${lang.flag} ${lang.description}`;
        if (lang.code === language) {
          option.selected = true;
        }
        combo.appendChild(option);
      });

      console.log("‚úÖ Language combo updated. Selected:", language);
    }

    // Carica traduzioni
    async function loadTranslations(lang) {
      console.log("üìö Loading translations for:", lang);
      try {
        const response = await fetch(`lang/${lang}.json`);
        if (!response.ok) throw new Error(`Translation file not found lang/${lang}.json`);
        translations = await response.json();
        console.log("‚úÖ Translations loaded for", lang);

        await loadCurrencies(lang);
        await loadTimezones();
      } catch (error) {
        console.error('‚ùå Error loading translations:', error);
      }
    }

    // Carica valute
    async function loadCurrencies(lang) {
      try {
        const response = await fetch(`currency/${lang}.json`);
        if (!response.ok) throw new Error(`Currency file not found currency/${lang}.json`);
        currencies = await response.json();
        console.log("‚úÖ Currencies loaded:", currencies.length);
      } catch (error) {
        console.error('‚ùå Error loading currencies:', error);
        currencies = [];
      }
    }

    // Carica timezone
    async function loadTimezones() {
      try {
        const response = await fetch(`timezone/timezone.json`);
        if (!response.ok) throw new Error("Timezone file not found");
        timezones = await response.json();
        console.log("‚úÖ Timezones loaded:", timezones.length);
      } catch (error) {
        console.error('‚ùå Error loading timezones:', error);
        timezones = [];
      }
    }

    // Ottieni traduzione
    function getTranslation(key) {
      return translations[key] || key;
    }

    // Aggiorna traduzioni pagina
    function updatePageTranslations() {
      console.log("üìÑ Updating page translations for language:", language);

      const formTitle = document.getElementById('form-title');
      if (formTitle) {
        formTitle.textContent = isLogin ? getTranslation('int.login') : getTranslation('int.registration');
      }

      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      if (usernameInput) usernameInput.placeholder = getTranslation('int.username');
      if (passwordInput) passwordInput.placeholder = getTranslation('int.password');

      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.textContent = isLogin ? getTranslation('int.signin') : getTranslation('int.create.account');
      }

      const forgotPassword = document.getElementById('forgot-password');
      const switchForm = document.getElementById('switch-form');
      if (forgotPassword) forgotPassword.textContent = getTranslation('int.forgot.password');
      if (switchForm) switchForm.textContent = isLogin ? getTranslation('int.no.account') : getTranslation('int.have.account');

      console.log("‚úÖ Page translations updated");
    }

    // Cambia lingua
    async function changeLanguage(langCode) {
      console.log("üåç Changing language from", language, "to", langCode);
      
      language = langCode;
      
      // Carica SEMPRE le traduzioni, anche se √® la stessa lingua
      await loadTranslations(langCode);
      updateLanguageCombo();
      updatePageTranslations();
      
      console.log("‚úÖ Language changed successfully to", langCode);
    }

    // Event listener per combobox lingue - usa 'input' per catturare anche i clic sulla stessa opzione
    document.getElementById('languageCombo').addEventListener('input', async (e) => {
      const selectedLang = e.target.value;
      console.log("üìù Language selector changed to:", selectedLang);
      
      if (selectedLang) {
        await changeLanguage(selectedLang);
      }
    });
    
    // Fallback con 'click' per assicurare che catturi sempre la selezione
    document.getElementById('languageCombo').addEventListener('click', async (e) => {
      const selectedLang = e.target.value;
      setTimeout(async () => {
        if (selectedLang && selectedLang !== language) {
          await changeLanguage(selectedLang);
        }
      }, 10);
    });

    // ========== LOGIN/REGISTRATION LOGIC ==========

    // Switch login/registration
    document.getElementById("switch-form").addEventListener("click", () => {
      isLogin = !isLogin;
      updatePageTranslations();
      document.getElementById("forgot-password").style.display = isLogin ? "block" : "none";
    });

    // Health check
    async function checkHealth() {
      try {
        const resUser = await fetch(`${apiBaseUser}/health`, { cache: "no-cache" });
        const resNew = await fetch(`${apiBaseNew}/health`, { cache: "no-cache" });

        if (!resUser.ok || !resNew.ok) throw new Error("Services unavailable");
        console.log("‚úÖ Services healthy");
      } catch (err) {
        console.error("‚ùå Service check failed:", err);
        document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;"><img src="images/off-line.jpeg" alt="Offline" class="offline"></div>';
      }
    }

    // Submit
    document.getElementById('submit-btn').addEventListener("click", async () => {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!username || !password) {
        alert(getTranslation("int.complete.all.fields") || "Please fill in all fields");
        return;
      }

      const apiUrl = isLogin ? `${apiBaseUser}/login` : `${apiBaseNew}/create`;
      const payload = { username, password, language };

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          mode: "cors",
          credentials: "omit",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload)
        });

        const contentType = response.headers.get("content-type");
        let data;
        if (contentType && contentType.includes("application/json")) {
          data = await response.json();
        } else {
          data = await response.text();
        }

        if (response.ok) {
          if (isLogin) {
            await loadTranslations(data.language || language);
            if (data.info && (!data.info.email || !data.info.language || !data.info.timezone || !data.info.currency)) {
              requestMissingInfo(data.info, username, password);
            } else {
              openDashboard(username, data.token, data.language);
            }
          } else {
            alert(getTranslation('int.creation.success') || "Account created successfully!");
            isLogin = true;
            updatePageTranslations();
            document.getElementById("username").value = username;
            document.getElementById("password").value = "";
          }
        } else {
          alert(isLogin ? getTranslation('int.login.failed') : getTranslation('int.creation.failed'));
        }
      } catch (err) {
        alert((getTranslation('int.connection.error') || "Connection error") + ": " + err.message);
      }
    });

    // Forgot password
    document.getElementById("forgot-password").addEventListener("click", () => {
      const email = prompt(getTranslation('int.enter.email') || "Enter your email:");
      if (email) alert(getTranslation('int.reset.email.sent') || "Email sent!");
    });

    // Richiesta info mancanti
    function requestMissingInfo(info, username, password) {
      document.querySelector('.language-selector').style.display = 'none';
      
      const container = document.getElementById("app-container");

      let currencyOptions = `<option value="">${getTranslation('int.select.currency')}</option>`;
      currencies.forEach(curr => {
        currencyOptions += `<option value="${curr.currency}">${curr['img.currency.flag']} ${curr.currency} - ${curr.description}</option>`;
      });

      let timezoneOptions = `<option value="">${getTranslation('int.select.timezone')}</option>`;
      timezones.forEach(tz => {
        timezoneOptions += `<option value="${tz.timezone}">${tz.timezone} (GMT${tz.offset_from_gmt}) - ${tz.reference_city}</option>`;
      });

      let languageOptions = `<option value="">${getTranslation('int.select.language')}</option>`;
      availableLanguages.forEach(lang => {
        languageOptions += `<option value="${lang.code}">${lang.flag} ${lang.description}</option>`;
      });

      container.innerHTML = `
        <h2>${getTranslation('int.complete.profile')}</h2>
        <div class="input-group">
          <i class="fa fa-envelope"></i>
          <input type="email" id="email" placeholder="${getTranslation('int.email')}" value="${info.email || ''}">
        </div>
        <div class="input-group">
          <i class="fa fa-language"></i>
          <select id="language">${languageOptions}</select>
        </div>
        <div class="input-group">
          <i class="fa fa-clock"></i>
          <select id="timezone">${timezoneOptions}</select>
        </div>
        <div class="input-group">
          <i class="fa fa-coins"></i>
          <select id="currency">${currencyOptions}</select>
        </div>
        <button id="save-info">${getTranslation('int.update')}</button>
      `;

      document.getElementById("save-info").addEventListener("click", async () => {
        const email = document.getElementById("email").value.trim();
        const lang = document.getElementById("language").value.trim();
        const currency = document.getElementById("currency").value.trim();
        const tz = document.getElementById("timezone").value.trim();

        if (!email || !lang || !currency || !tz) {
          alert(getTranslation('int.complete.all.fields'));
          return;
        }

        try {
          const response = await fetch(`${apiBaseUser}/update`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password, email, language: lang, currency, timezone: tz })
          });

          const data = await response.json();
          if (response.ok && data.status === "ok") {
            alert(getTranslation('int.info.saved'));
            document.querySelector('.language-selector').style.display = 'block';
            window.location.href = "index.html";
          } else {
            alert(getTranslation("int.error.update"));
          }
        } catch (err) {
          alert(getTranslation("int.error.saving"));
        }
      });
    }

    // Apertura dashboard
    function openDashboard(username, token, lang) {
      localStorage.setItem("username", username);
      localStorage.setItem("token", token);
      localStorage.setItem("language", lang);
      window.location.href = "dashboard.html";
    }

    // ========== INITIALIZATION ==========
    async function init() {
      console.log("üöÄ Initializing application...");
      
      // 1. Inizializza le lingue disponibili
      await initializeLanguages();
      
      // 2. Carica le traduzioni per la lingua di default
      await loadTranslations(language);
      
      // 3. Aggiorna il combo per mostrare la lingua di default selezionata
      updateLanguageCombo();
      
      // 4. Traduci la pagina
      updatePageTranslations();
      
      // 5. Health check
      checkHealth();
      
      console.log("‚úÖ Application initialized successfully");
    }

    init();
  </script>
</body>

</html>