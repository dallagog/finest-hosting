<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinEst, ver. 0.29 beta</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      position: relative;
    }

    .language-selector {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .language-selector-label {
      font-size: 14px;
      color: #555;
      margin-bottom: 8px;
      display: block;
    }

    .language-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #007bff;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
      max-width: 400px;
    }

    .language-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 12px 8px;
      border: 2px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
      text-align: center;
      font-size: 12px;
    }

    .language-option:hover {
      border-color: #007bff;
      background: #f0f7ff;
    }

    .language-option.active {
      border-color: #007bff;
      background: #007bff;
      color: white;
    }

    .language-flag {
      font-size: 32px;
      margin-bottom: 4px;
    }

    .language-code {
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 2px;
    }

    .language-description {
      font-size: 11px;
      opacity: 0.8;
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      width: 320px;
      text-align: center;
    }

    .logo {
      width: 100px;
      margin-bottom: 15px;
    }

    h2 {
      margin-bottom: 30px;
    }

    .input-group {
      position: relative;
      margin-bottom: 25px;
      text-align: left;
    }

    .input-group i {
      position: absolute;
      top: 10px;
      left: 0;
      color: #555;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 10px 10px 10px 30px;
      border: none;
      border-bottom: 2px solid #ccc;
      outline: none;
      transition: 0.3s;
      box-sizing: border-box;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-bottom-color: #007bff;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      background: #007bff;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    .switch,
    .forgot {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      cursor: pointer;
    }

    .forgot:hover,
    .switch:hover {
      text-decoration: underline;
    }

    .offline {
      width: 300px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <!-- Selettore lingua in alto a destra -->
  <div class="language-selector">
    <label class="language-selector-label" id="int.choose.language">Choose language</label>
    <div class="language-grid" id="languageGrid"></div>
  </div>

  <div class="container" id="app-container">
    <img src="images/under_construction.jpeg" alt="Logo" class="logo">
    <h2 id="form-title">Login</h2>

    <div class="input-group">
      <i class="fa fa-user"></i>
      <input type="text" id="username" placeholder="Username">
    </div>
    <div class="input-group">
      <i class="fa fa-lock"></i>
      <input type="password" id="password" placeholder="Password">
    </div>

    <button id="submit-btn">Sign in</button>
    <div class="forgot" id="forgot-password">Forgot password? Reset password</div>
    <div class="switch" id="switch-form">Don't have an account? Sign up</div>
  </div>

  <script>
    const apiBaseNew = "https://new-user-tunnel.fe-web.eu";
    const apiBaseUser = "https://user-tunnel.fe-web.eu";

    let language = 'en_UK';
    let translations = {};
    let currencies = [];
    let timezones = [];
    let languages = [];
    let isLogin = true;

    console.log("=== FinEst Login v0.29 - Debug Mode ===");
    console.log("Initial language:", language);

    // Caricamento traduzioni dai file JSON
    async function loadTranslations(lang) {
      console.log("üìö Loading translations for:", lang);
      try {
        const response = await fetch(`lang/${lang}.json`);
        console.log("Translation fetch response:", response.status, response.ok);
        if (!response.ok) throw new Error((getTranslation("int.error.loading") || "Loading error:") + lang);
        translations = await response.json();
        console.log("‚úÖ Translations loaded successfully:", Object.keys(translations).length, "keys");
        
        // Carica le valute per la lingua corrente
        await loadCurrencies(lang);
        // Carica le lingue per la lingua corrente
        await loadLanguages(lang);
        
        updatePageTranslations();
      } catch (error) {
        console.error('‚ùå Errore caricamento traduzioni:', error);
      }
    }

    // Caricamento valute specifiche per lingua
    async function loadCurrencies(lang) {
      console.log("üí∞ Loading currencies for:", lang);
      try {
        const response = await fetch(`currency/${lang}.json`);
        if (!response.ok) throw new Error("Currency loading error");
        currencies = await response.json();
        console.log("‚úÖ Currencies loaded:", currencies.length);
      } catch (error) {
        console.error('‚ùå Errore caricamento valute:', error);
        currencies = [];
      }
    }

    // Caricamento timezone
    async function loadTimezones() {
      console.log("üåç Loading timezones...");
      try {
        const response = await fetch(`timezone/timezone.json`);
        if (!response.ok) throw new Error("Timezone loading error");
        timezones = await response.json();
        console.log("‚úÖ Timezones loaded:", timezones.length);
      } catch (error) {
        console.error('‚ùå Errore caricamento timezone:', error);
        timezones = [];
      }
    }

    // Caricamento lingue specifiche per lingua - AGGIORNATO
    async function loadLanguages(lang) {
      console.log("üó£Ô∏è Loading languages for:", lang);
      try {
        const response = await fetch(`lang/${lang}.json`);
        if (!response.ok) throw new Error("Language loading error");
        const data = await response.json();
        // Estrai solo gli elementi che hanno la struttura lingua (language, description, img.language.flag)
        languages = Array.isArray(data) ? data : [];
        console.log("‚úÖ Languages loaded:", languages.length);
        updateLanguageGrid();
      } catch (error) {
        console.error('‚ùå Errore caricamento lingue:', error);
        languages = [];
      }
    }

    // Carica tutte le lingue disponibili dalla cartella /lang
    async function loadAllAvailableLanguages() {
      console.log("üó£Ô∏è Loading all available languages from /lang...");
      languages = [];
      
      try {
        // Recupera l'elenco dei file dalla cartella /lang (richiede supporto server)
        const response = await fetch('lang/');
        if (!response.ok) {
          console.error("‚ùå Cannot access lang directory, status:", response.status);
          throw new Error("Directory listing not available");
        }
        
        const html = await response.text();
        // Estrai i file .json dal listing HTML (pattern per Apache, Nginx, etc.)
        const fileRegex = /(?:href|name)=["']?([a-zA-Z0-9_]+\.json)["']?/gi;
        const files = new Set();
        let match;
        
        while ((match = fileRegex.exec(html)) !== null) {
          files.add(match[1]);
        }
        
        if (files.size === 0) {
          throw new Error("No JSON files found in directory listing");
        }
        
        console.log("üìÅ Found language files:", Array.from(files));
        
        // Carica ogni file di lingua trovato
        for (const file of files) {
          if (!file.endsWith('.json')) continue;
          
          try {
            const langResponse = await fetch(`lang/${file}`);
            if (!langResponse.ok) continue;
            const data = await langResponse.json();
            
            if (data['int.language.code'] && data['int.language.description'] && data['img.language.flag']) {
              languages.push({
                code: data['int.language.code'],
                description: data['int.language.description'],
                flag: data['img.language.flag']
              });
            }
          } catch (error) {
            console.error(`Error loading language file ${file}:`, error);
          }
        }
        
        if (languages.length === 0) {
          throw new Error("No valid language files loaded");
        }
        
      } catch (error) {
        console.error("‚ùå Error loading languages:", error.message);
        console.warn("‚ö†Ô∏è Unable to load language list from /lang directory");
      }
      
      console.log("‚úÖ All available languages loaded:", languages.length);
      updateLanguageGrid();
    }

    // Aggiorna la griglia delle lingue
    function updateLanguageGrid() {
      const grid = document.getElementById('languageGrid');
      grid.innerHTML = '';
      
      languages.forEach(lang => {
        const option = document.createElement('div');
        option.className = `language-option ${lang.code === language ? 'active' : ''}`;
        option.innerHTML = `
          <div class="language-flag">${lang.flag || 'üåê'}</div>
          <div class="language-code">${lang.code}</div>
          <div class="language-description">${lang.description || ''}</div>
        `;
        option.addEventListener('click', () => {
          console.log("üåç Language changed to:", lang.code);
          language = lang.code;
          loadTranslations(language);
          updateLanguageGrid();
        });
        grid.appendChild(option);
      });
    }

    function getTranslation(key) {
      const value = translations[key] || key;
      console.log(`üî§ Translation [${key}]:`, value);
      return value;
    }

    function updatePageTranslations() {
      console.log("üîÑ Updating page translations, isLogin:", isLogin);
      
      // Aggiorna titolo form
      const formTitle = document.getElementById('form-title');
      if (formTitle) {
        formTitle.textContent = isLogin ? getTranslation('int.login') : getTranslation('int.registration');
      }

      // Aggiorna placeholder
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      if (usernameInput) usernameInput.placeholder = getTranslation('int.username');
      if (passwordInput) passwordInput.placeholder = getTranslation('int.password');

      // Aggiorna bottone
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.textContent = isLogin ? getTranslation('int.signin') : getTranslation('int.create.account');
      }

      // Aggiorna link
      const forgotPassword = document.getElementById('forgot-password');
      const switchForm = document.getElementById('switch-form');
      if (forgotPassword) forgotPassword.textContent = getTranslation('int.forgot.password');
      if (switchForm) {
        switchForm.textContent = isLogin ? getTranslation('int.no.account') : getTranslation('int.have.account');
      }

      // Aggiorna etichetta selettore lingue
      const langLabel = document.getElementById('int.choose.language');
      if (langLabel) langLabel.textContent = getTranslation('int.choose.language');
    }

    // Carica tutte le lingue disponibili al primo avvio
    loadAllAvailableLanguages();
    
    // Carica lingua di default e timezone
    loadTranslations(language);
    loadTimezones();

    async function checkHealth() {
      console.log("üè• Checking service health...");
      try {
        const resUser = await fetch(`${apiBaseUser}/health`, { cache: "no-cache" });
        const resNew = await fetch(`${apiBaseNew}/health`, { cache: "no-cache" });
        console.log("User service health:", resUser.status, resUser.ok);
        console.log("New user service health:", resNew.status, resNew.ok);
        
        if (!resUser.ok || !resNew.ok) throw new Error("HTTP error");
        
        const dataUser = await resUser.json();
        const dataNew = await resNew.json();
        console.log("User service data:", dataUser);
        console.log("New user service data:", dataNew);
        
        if (dataUser.status !== "ok" || dataNew.status !== "ok") throw new Error("Service not OK");
        console.log("‚úÖ All services are healthy");
      } catch (err) {
        console.error("‚ùå Service check failed:", err);
        document.body.innerHTML = `
        <div style="display:flex;justify-content:center;align-items:center;height:100vh;">
          <img src="images/off-line.jpeg" alt="Offline" class="offline">
        </div>
      `;
      }
    }
    checkHealth();

    // === LOGIN / REGISTRAZIONE SWITCH ===
    const switchForm = document.getElementById("switch-form");

    switchForm.addEventListener("click", () => {
      isLogin = !isLogin;
      console.log("üîÑ Switched form mode to:", isLogin ? "LOGIN" : "REGISTRATION");
      updatePageTranslations();
      document.getElementById("forgot-password").style.display = isLogin ? "block" : "none";
    });

    // === LOGIN / REGISTER ===
    document.getElementById('submit-btn').addEventListener("click", async () => {
      console.log("\n=== SUBMIT BUTTON CLICKED ===");
      console.log("Mode:", isLogin ? "LOGIN" : "REGISTRATION");
      
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      
      console.log("Username:", username);
      console.log("Password:", password ? "***" + password.slice(-2) : "(empty)");
      console.log("Current language:", language);
      
      if (!username || !password) {
        console.warn("‚ö†Ô∏è Missing username or password");
        alert(getTranslation("int.complete.all.fields") || "Please fill in all fields");
        return;
      }

      const apiUrl = isLogin ? `${apiBaseUser}/login` : `${apiBaseNew}/create`;
      const payload = { username, password, language};

      console.log("üì§ API URL:", apiUrl);
      console.log("üì§ Payload:", { username, password: "***", language });

      try {
        console.log("üåê Sending fetch request...");
        console.log("üîç Testing endpoint reachability first...");
        
        // Test preliminare: prova una semplice GET
        try {
          const testResponse = await fetch(apiUrl.replace('/login', '/health').replace('/create', '/health'), {
            method: "GET",
            mode: "cors"
          });
          console.log("‚úÖ Health check response:", testResponse.status);
        } catch (testErr) {
          console.error("‚ùå Health check failed:", testErr.message);
          console.error("This suggests the server is not reachable or CORS is blocking");
        }
        
        console.log("üì§ Now attempting actual request with mode and credentials...");
        const response = await fetch(apiUrl, {
          method: "POST",
          mode: "cors",
          credentials: "omit",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(payload)
        });

        console.log("üì• Response received:");
        console.log("  - Status:", response.status);
        console.log("  - Status Text:", response.statusText);
        console.log("  - OK:", response.ok);
        console.log("  - Headers:", [...response.headers.entries()]);

        const contentType = response.headers.get("content-type");
        console.log("  - Content-Type:", contentType);
        
        let data;
        if (contentType && contentType.includes("application/json")) {
          data = await response.json();
          console.log("üìÑ Response data (JSON):", data);
        } else {
          data = await response.text();
          console.log("üìÑ Response data (TEXT):", data);
        }

        if (response.ok) {
          console.log("‚úÖ Request successful");
          if (isLogin) {
            console.log("üîê Processing login...");
            
            await loadTranslations(data.language || language);
            if (data.info && (!data.info.email || !data.info.language || !data.info.timezone || !data.info.currency)) {
              console.log("‚ÑπÔ∏è Missing user info, requesting completion");
              requestMissingInfo(data.info, username, password);
            } else {
              console.log("‚úÖ User info complete, opening dashboard with language: "+data.language);
              openDashboard(username, data.token, data.language);
            }
          } else {
            console.log("‚úÖ Registration successful");
            alert(getTranslation('int.creation.success') || "Account created successfully! Please log in.");
            isLogin = true;
            updatePageTranslations();
            document.getElementById("username").value = username;
            document.getElementById("password").value = "";
          }
        } else {
          console.error("‚ùå Request failed");
          if (isLogin) {
            console.error("Login failed with status:", response.status);
            alert(getTranslation('int.login.failed') || "Login failed");
          } else {
            console.error("Registration failed with status:", response.status);
            const errorMsg = getTranslation('int.creation.failed') || "Creation failed";
            const detailMsg = typeof data === 'object' ? (data.message || JSON.stringify(data)) : data;
            alert(errorMsg + "\n\nStatus: " + response.status + "\nDetails: " + detailMsg);
          }
        }
      } catch (err) {
        console.error("‚ùå Exception caught:", err);
        console.error("Error name:", err.name);
        console.error("Error message:", err.message);
        console.error("Error stack:", err.stack);
        console.error("Full error object:", err);
        
        // Mostra anche nell'alert maggiori dettagli
        const errorDetails = `
Name: ${err.name}
Message: ${err.message}
Type: ${err.constructor.name}
        `.trim();
        
        alert((getTranslation('int.connection.error') || "Connection error:") + "\n\n" + errorDetails);
      }
    });

    // === FORGOT PASSWORD ===
    document.getElementById("forgot-password").addEventListener("click", () => {
      console.log("üîë Forgot password clicked");
      const email = prompt(getTranslation('int.enter.email') || "Enter your email to reset password:");
      console.log("Email entered:", email);
      if (!email) return;
      alert(getTranslation('int.reset.email.sent') || "If this email is registered, you will receive a password reset link.");
    });

    // === UPDATE INFO E RITORNO AL LOGIN ===
    function requestMissingInfo(info, username, password) {
      console.log("üìù Requesting missing info:", info);
      const container = document.getElementById("app-container");
      
      // Crea le opzioni per le valute
      let currencyOptions = `<option value="">${getTranslation('int.select.currency')}</option>`;
      currencies.forEach(curr => {
        const selected = info.currency === curr.currency ? 'selected' : '';
        currencyOptions += `<option value="${curr.currency}" ${selected}>${curr['img.currency.flag']} ${curr.currency} - ${curr.description}</option>`;
      });
      
      // Crea le opzioni per i timezone
      let timezoneOptions = `<option value="">${getTranslation('int.select.timezone') || 'Select Timezone'}</option>`;
      timezones.forEach(tz => {
        const selected = info.timezone === tz.timezone ? 'selected' : '';
        timezoneOptions += `<option value="${tz.timezone}" ${selected}>${tz.timezone} (GMT${tz.offset_from_gmt}) - ${tz.reference_city}</option>`;
      });
      
      // Crea le opzioni per le lingue - AGGIORNATO per usare il grid
      let languageOptions = `<option value="">${getTranslation('int.select.language')}</option>`;
      languages.forEach(lang => {
        const selected = info.language === lang.code ? 'selected' : '';
        languageOptions += `<option value="${lang.code}" ${selected}>${lang.flag} ${lang.code} - ${lang.description}</option>`;
      });
      
      container.innerHTML = `
        <h2>${getTranslation('int.complete.profile')}</h2>
        <div class="input-group">
          <i class="fa fa-envelope"></i>
          <input type="email" id="email" placeholder="${getTranslation('int.email')}" value="${info.email || ''}">
        </div>
        <div class="input-group">
          <i class="fa fa-language"></i>
          <select id="language">
            ${languageOptions}
          </select>
        </div>
        <div class="input-group">
          <i class="fa fa-clock"></i>
          <select id="timezone">
            ${timezoneOptions}
          </select>
        </div>
        <div class="input-group">
          <i class="fa fa-coins"></i>
          <select id="currency">
            ${currencyOptions}
          </select>
        </div>
        <button id="save-info">${getTranslation('int.update')}</button>
      `;

      document.getElementById("save-info").addEventListener("click", async () => {
        console.log("üíæ Save info clicked");
        const email = document.getElementById("email").value.trim();
        const language = document.getElementById("language").value.trim();
        const currency = document.getElementById("currency").value.trim();
        const timezone = document.getElementById("timezone").value.trim();

        console.log("Data to save:", { email, language, currency, timezone });

        if (!email || !language || !currency || !timezone) {
          console.warn("‚ö†Ô∏è Incomplete fields");
          alert(getTranslation('int.complete.all.fields') || "Please complete all fields.");
          return;
        }

        try {
          console.log("üì§ Sending update request...");
          const response = await fetch(`${apiBaseUser}/update`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password, email, language, currency, timezone })
          });

          console.log("Update response status:", response.status);
          const data = await response.json();
          console.log("Update response data:", data);

          if (response.ok && data.status === "ok") {
            console.log("‚úÖ Info saved successfully");
            alert(getTranslation('int.info.saved') || "Information saved successfully! Please log in again.");
            window.location.href = "index.html";
          } else {
            console.error("‚ùå Update failed");
            alert((getTranslation("int.error.update") || "Update failed: ") + data.message);
          }
        } catch (err) {
          console.error("‚ùå Error saving info:", err);
          alert((getTranslation("int.error.saving") || "Error saving info: ") + err.message);
        }
      });
    }

    function openDashboard(username, token, language) {
      console.log("üö™ Opening dashboard for user:", username);
      console.log("Token:", token ? "***" + token.slice(-10) : "(none)");
      localStorage.setItem("username", username);
      localStorage.setItem("token", token);
      localStorage.setItem("language", language);
      console.log("‚úÖ Data saved to localStorage");
      window.location.href = "dashboard.html";
    }
  </script>
</body>

</html>