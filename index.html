<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinEst, ver. 0.29 beta</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      position: relative;
    }

    .language-selector {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .language-selector-title {
      font-size: 14px;
      color: #555;
      margin-bottom: 12px;
      display: block;
      font-weight: bold;
    }

    .language-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #007bff;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
      max-width: 500px;
    }

    .language-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 12px 8px;
      border: 2px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
      text-align: center;
      font-size: 12px;
    }

    .language-option:hover {
      border-color: #007bff;
      background: #f0f7ff;
    }

    .language-option.active {
      border-color: #007bff;
      background: #007bff;
      color: white;
    }

    .language-flag {
      font-size: 32px;
      margin-bottom: 4px;
      line-height: 1;
    }

    .language-code {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 2px;
    }

    .language-description {
      font-size: 11px;
      opacity: 0.8;
      word-break: break-word;
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      width: 320px;
      text-align: center;
    }

    .logo {
      width: 100px;
      margin-bottom: 15px;
    }

    h2 {
      margin-bottom: 30px;
    }

    .input-group {
      position: relative;
      margin-bottom: 25px;
      text-align: left;
    }

    .input-group i {
      position: absolute;
      top: 10px;
      left: 0;
      color: #555;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 10px 10px 10px 30px;
      border: none;
      border-bottom: 2px solid #ccc;
      outline: none;
      transition: 0.3s;
      box-sizing: border-box;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-bottom-color: #007bff;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      background: #007bff;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    .switch,
    .forgot {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      cursor: pointer;
    }

    .forgot:hover,
    .switch:hover {
      text-decoration: underline;
    }

    .offline {
      width: 300px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <!-- Selettore lingua in alto a destra -->
  <div class="language-selector">
    <label class="language-selector-title" id="lang-selector-title">Choose language</label>
    <div class="language-grid" id="languageGrid">
      <div style="padding: 20px; color: #999;">Loading languages...</div>
    </div>
  </div>

  <div class="container" id="app-container">
    <img src="images/under_construction.jpeg" alt="Logo" class="logo">
    <h2 id="form-title">Login</h2>

    <div class="input-group">
      <i class="fa fa-user"></i>
      <input type="text" id="username" placeholder="Username">
    </div>
    <div class="input-group">
      <i class="fa fa-lock"></i>
      <input type="password" id="password" placeholder="Password">
    </div>

    <button id="submit-btn">Sign in</button>
    <div class="forgot" id="forgot-password">Forgot password? Reset password</div>
    <div class="switch" id="switch-form">Don't have an account? Sign up</div>
  </div>

  <script>
    const apiBaseNew = "https://new-user-tunnel.fe-web.eu";
    const apiBaseUser = "https://user-tunnel.fe-web.eu";

    let language = 'en_UK';
    let translations = {};
    let currencies = [];
    let timezones = [];
    let availableLanguages = [];
    let isLogin = true;

    console.log("=== FinEst Login v0.29 - Debug Mode ===");
    console.log("Initial language:", language);

    // ====== CARICAMENTO LINGUE DISPONIBILI ======
    async function discoverAvailableLanguages() {
      console.log("üîç Discovering available languages from /lang directory...");
      availableLanguages = [];

      // Tenta diversi approcci per scoprire i file
      try {
        // Approach 1: Fetch directory listing (funziona con alcuni server)
        const dirResponse = await fetch('lang/');
        if (dirResponse.ok) {
          const html = await dirResponse.text();
          console.log("üìÅ Directory listing received, parsing...");
          
          // Regex per trovare file .json nel listing HTML
          const fileRegex = /["\']([a-zA-Z0-9_-]+\.json)["\']/g;
          let match;
          const files = new Set();
          
          while ((match = fileRegex.exec(html)) !== null) {
            if (match[1].endsWith('.json')) {
              files.add(match[1]);
            }
          }
          
          console.log("üìÑ Files found:", Array.from(files));
          
          for (const fileName of files) {
            await loadLanguageFile(fileName);
          }
        }
      } catch (error) {
        console.warn("‚ö†Ô∏è Directory listing failed:", error.message);
      }

      // Se non trovato nulla, prova a caricare file comuni
      if (availableLanguages.length === 0) {
        console.log("üìã No languages found, trying common language files...");
        const commonFiles = ['en_UK.json', 'it_IT.json', 'de_DE.json', 'fr_FR.json', 'es_ES.json', 'zh_CN.json', 'ar_SA.json'];
        
        for (const fileName of commonFiles) {
          await loadLanguageFile(fileName);
        }
      }

      console.log("‚úÖ Available languages discovered:", availableLanguages.length);
      availableLanguages.sort((a, b) => a.code.localeCompare(b.code));
      
      updateLanguageGrid();
    }

    // Carica un singolo file di lingua
    async function loadLanguageFile(fileName) {
      try {
        const response = await fetch(`lang/${fileName}`);
        if (!response.ok) {
          console.log(`‚è≠Ô∏è File not found: lang/${fileName}`);
          return;
        }

        const data = await response.json();
        
        // Verifica che abbia i campi richiesti
        if (data['int.language.code'] && data['int.language.description'] && data['img.language.flag']) {
          const lang = {
            code: data['int.language.code'],
            description: data['int.language.description'],
            flag: data['img.language.flag']
          };
          
          // Evita duplicati
          if (!availableLanguages.some(l => l.code === lang.code)) {
            availableLanguages.push(lang);
            console.log(`‚úÖ Language loaded: ${lang.code} - ${lang.description}`);
          }
        } else {
          console.warn(`‚ö†Ô∏è Invalid structure in ${fileName}`);
        }
      } catch (error) {
        console.error(`‚ùå Error loading ${fileName}:`, error.message);
      }
    }

    // ====== AGGIORNAMENTO GRIGLIA LINGUE ======
    function updateLanguageGrid() {
      const grid = document.getElementById('languageGrid');
      grid.innerHTML = '';

      if (availableLanguages.length === 0) {
        grid.innerHTML = '<div style="padding: 20px; color: #999; grid-column: 1/-1;">No languages available</div>';
        return;
      }

      availableLanguages.forEach(lang => {
        const option = document.createElement('div');
        option.className = `language-option ${lang.code === language ? 'active' : ''}`;
        option.innerHTML = `
          <div class="language-flag">${lang.flag}</div>
          <div class="language-code">${lang.code}</div>
          <div class="language-description">${lang.description}</div>
        `;
        option.addEventListener('click', () => changeLanguage(lang.code));
        grid.appendChild(option);
      });
    }

    // ====== CAMBIO LINGUA ======
    async function changeLanguage(langCode) {
      console.log("üåç Changing language to:", langCode);
      language = langCode;
      await loadTranslations(language);
      updateLanguageGrid();
      updatePageTranslations();
    }

    // ====== CARICAMENTO TRADUZIONI ======
    async function loadTranslations(lang) {
      console.log("üìö Loading translations for:", lang);
      try {
        const response = await fetch(`lang/${lang}.json`);
        if (!response.ok) throw new Error("Translation file not found");
        translations = await response.json();
        console.log("‚úÖ Translations loaded:", Object.keys(translations).length, "keys");
        
        await loadCurrencies(lang);
        await loadTimezones();
        
      } catch (error) {
        console.error('‚ùå Error loading translations:', error);
      }
    }

    // ====== CARICAMENTO VALUTE ======
    async function loadCurrencies(lang) {
      console.log("üí∞ Loading currencies for:", lang);
      try {
        const response = await fetch(`currency/${lang}.json`);
        if (!response.ok) throw new Error("Currency file not found");
        currencies = await response.json();
        console.log("‚úÖ Currencies loaded:", currencies.length);
      } catch (error) {
        console.error('‚ùå Error loading currencies:', error);
        currencies = [];
      }
    }

    // ====== CARICAMENTO TIMEZONE ======
    async function loadTimezones() {
      console.log("üåç Loading timezones...");
      try {
        const response = await fetch(`timezone/timezone.json`);
        if (!response.ok) throw new Error("Timezone file not found");
        timezones = await response.json();
        console.log("‚úÖ Timezones loaded:", timezones.length);
      } catch (error) {
        console.error('‚ùå Error loading timezones:', error);
        timezones = [];
      }
    }

    // ====== HELPER TRADUZIONI ======
    function getTranslation(key) {
      const value = translations[key] || key;
      return value;
    }

    // ====== AGGIORNAMENTO PAGINA ======
    function updatePageTranslations() {
      console.log("üîÑ Updating page translations");
      
      // Titolo selector lingue
      const langTitle = document.getElementById('lang-selector-title');
      if (langTitle) {
        langTitle.textContent = getTranslation('int.choose.language') || 'Choose language';
      }

      // Titolo form
      const formTitle = document.getElementById('form-title');
      if (formTitle) {
        formTitle.textContent = isLogin ? getTranslation('int.login') : getTranslation('int.registration');
      }

      // Placeholder input
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      if (usernameInput) usernameInput.placeholder = getTranslation('int.username');
      if (passwordInput) passwordInput.placeholder = getTranslation('int.password');

      // Bottone
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.textContent = isLogin ? getTranslation('int.signin') : getTranslation('int.create.account');
      }

      // Link
      const forgotPassword = document.getElementById('forgot-password');
      const switchForm = document.getElementById('switch-form');
      if (forgotPassword) forgotPassword.textContent = getTranslation('int.forgot.password');
      if (switchForm) {
        switchForm.textContent = isLogin ? getTranslation('int.no.account') : getTranslation('int.have.account');
      }
    }

    // ====== SWITCH LOGIN/REGISTRATION ======
    document.getElementById("switch-form").addEventListener("click", () => {
      isLogin = !isLogin;
      console.log("üîÑ Switched form mode to:", isLogin ? "LOGIN" : "REGISTRATION");
      updatePageTranslations();
      document.getElementById("forgot-password").style.display = isLogin ? "block" : "none";
    });

    // ====== HEALTH CHECK ======
    async function checkHealth() {
      console.log("üè• Checking service health...");
      try {
        const resUser = await fetch(`${apiBaseUser}/health`, { cache: "no-cache" });
        const resNew = await fetch(`${apiBaseNew}/health`, { cache: "no-cache" });
        
        if (!resUser.ok || !resNew.ok) throw new Error("Service unavailable");
        
        const dataUser = await resUser.json();
        const dataNew = await resNew.json();
        
        if (dataUser.status !== "ok" || dataNew.status !== "ok") throw new Error("Service not OK");
        console.log("‚úÖ All services are healthy");
      } catch (err) {
        console.error("‚ùå Service check failed:", err);
        document.body.innerHTML = `
          <div style="display:flex;justify-content:center;align-items:center;height:100vh;">
            <img src="images/off-line.jpeg" alt="Offline" class="offline">
          </div>
        `;
      }
    }

    // ====== SUBMIT LOGIN/REGISTRATION ======
    document.getElementById('submit-btn').addEventListener("click", async () => {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      
      if (!username || !password) {
        alert(getTranslation("int.complete.all.fields") || "Please fill in all fields");
        return;
      }

      const apiUrl = isLogin ? `${apiBaseUser}/login` : `${apiBaseNew}/create`;
      const payload = { username, password, language };

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          mode: "cors",
          credentials: "omit",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const contentType = response.headers.get("content-type");
        let data;
        if (contentType && contentType.includes("application/json")) {
          data = await response.json();
        } else {
          data = await response.text();
        }

        if (response.ok) {
          if (isLogin) {
            await loadTranslations(data.language || language);
            if (data.info && (!data.info.email || !data.info.language || !data.info.timezone || !data.info.currency)) {
              requestMissingInfo(data.info, username, password);
            } else {
              openDashboard(username, data.token, data.language);
            }
          } else {
            alert(getTranslation('int.creation.success') || "Account created successfully!");
            isLogin = true;
            updatePageTranslations();
            document.getElementById("username").value = username;
            document.getElementById("password").value = "";
          }
        } else {
          if (isLogin) {
            alert(getTranslation('int.login.failed') || "Login failed");
          } else {
            alert(getTranslation('int.creation.failed') || "Registration failed");
          }
        }
      } catch (err) {
        alert((getTranslation('int.connection.error') || "Connection error") + ": " + err.message);
      }
    });

    // ====== FORGOT PASSWORD ======
    document.getElementById("forgot-password").addEventListener("click", () => {
      const email = prompt(getTranslation('int.enter.email') || "Enter your email:");
      if (email) {
        alert(getTranslation('int.reset.email.sent') || "Email sent!");
      }
    });

    // ====== RICHIESTA INFORMAZIONI MANCANTI ======
    function requestMissingInfo(info, username, password) {
      const container = document.getElementById("app-container");
      
      let currencyOptions = `<option value="">${getTranslation('int.select.currency')}</option>`;
      currencies.forEach(curr => {
        const selected = info.currency === curr.currency ? 'selected' : '';
        currencyOptions += `<option value="${curr.currency}" ${selected}>${curr['img.currency.flag']} ${curr.currency}</option>`;
      });
      
      let timezoneOptions = `<option value="">${getTranslation('int.select.timezone')}</option>`;
      timezones.forEach(tz => {
        const selected = info.timezone === tz.timezone ? 'selected' : '';
        timezoneOptions += `<option value="${tz.timezone}" ${selected}>${tz.timezone}</option>`;
      });
      
      let languageOptions = `<option value="">${getTranslation('int.select.language')}</option>`;
      availableLanguages.forEach(lang => {
        const selected = info.language === lang.code ? 'selected' : '';
        languageOptions += `<option value="${lang.code}" ${selected}>${lang.flag} ${lang.code}</option>`;
      });
      
      container.innerHTML = `
        <h2>${getTranslation('int.complete.profile')}</h2>
        <div class="input-group">
          <i class="fa fa-envelope"></i>
          <input type="email" id="email" placeholder="${getTranslation('int.email')}" value="${info.email || ''}">
        </div>
        <div class="input-group">
          <i class="fa fa-language"></i>
          <select id="language">${languageOptions}</select>
        </div>
        <div class="input-group">
          <i class="fa fa-clock"></i>
          <select id="timezone">${timezoneOptions}</select>
        </div>
        <div class="input-group">
          <i class="fa fa-coins"></i>
          <select id="currency">${currencyOptions}</select>
        </div>
        <button id="save-info">${getTranslation('int.update')}</button>
      `;

      document.getElementById("save-info").addEventListener("click", async () => {
        const email = document.getElementById("email").value.trim();
        const lang = document.getElementById("language").value.trim();
        const currency = document.getElementById("currency").value.trim();
        const tz = document.getElementById("timezone").value.trim();

        if (!email || !lang || !currency || !tz) {
          alert(getTranslation('int.complete.all.fields'));
          return;
        }

        try {
          const response = await fetch(`${apiBaseUser}/update`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password, email, language: lang, currency, timezone: tz })
          });

          const data = await response.json();
          if (response.ok && data.status === "ok") {
            alert(getTranslation('int.info.saved'));
            window.location.href = "index.html";
          } else {
            alert(getTranslation("int.error.update"));
          }
        } catch (err) {
          alert(getTranslation("int.error.saving"));
        }
      });
    }

    // ====== APERTURA DASHBOARD ======
    function openDashboard(username, token, lang) {
      localStorage.setItem("username", username);
      localStorage.setItem("token", token);
      localStorage.setItem("language", lang);
      window.location.href = "dashboard.html";
    }

    // ====== INIZIALIZZAZIONE ======
    async function init() {
      await discoverAvailableLanguages();
      await loadTranslations(language);
      updatePageTranslations();
      checkHealth();
    }

    init();
  </script>
</body>

</html>