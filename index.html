<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinEst, ver. 0.20 beta</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      position: relative;
    }

    .language-selector {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .language-selector select {
      padding: 8px 12px;
      border: 2px solid #007bff;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      outline: none;
      transition: 0.3s;
    }

    .language-selector select:hover {
      border-color: #0056b3;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      width: 320px;
      text-align: center;
    }

    .logo {
      width: 100px;
      margin-bottom: 15px;
    }

    h2 {
      margin-bottom: 30px;
    }

    .input-group {
      position: relative;
      margin-bottom: 25px;
      text-align: left;
    }

    .input-group i {
      position: absolute;
      top: 10px;
      left: 0;
      color: #555;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 10px 10px 10px 30px;
      border: none;
      border-bottom: 2px solid #ccc;
      outline: none;
      transition: 0.3s;
      box-sizing: border-box;
    }

    .input-group input:focus,
    .input-group select:focus {
      border-bottom-color: #007bff;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      background: #007bff;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    .switch,
    .forgot {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      color: #555;
      cursor: pointer;
    }

    .forgot:hover,
    .switch:hover {
      text-decoration: underline;
    }

    .offline {
      width: 300px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <!-- Selettore lingua in alto a destra -->
  <div class="language-selector">
    <label for="languageSelector" id="int.choose.language"></label>
    <select id="languageSelector">
      <option value="en_UK">ðŸ‡¬ðŸ‡§ English</option>
      <option value="it_IT">ðŸ‡®ðŸ‡¹ Italiano</option>
      <option value="de_DE">ðŸ‡©ðŸ‡ª Deutsch</option>
      <option value="fr_FR">ðŸ‡«ðŸ‡· FranÃ§ais</option>
      <option value="es_ES">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
      <option value="zh_CN">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
      <option value="ar_SA">ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>
  </div>

  <div class="container" id="app-container">
    <img src="images/under_construction.jpeg" alt="Logo" class="logo">
    <h2 id="form-title">Login</h2>

    <div class="input-group">
      <i class="fa fa-user"></i>
      <input type="text" id="username" placeholder="Username">
    </div>
    <div class="input-group">
      <i class="fa fa-lock"></i>
      <input type="password" id="password" placeholder="Password">
    </div>

    <button id="submit-btn">Sign in</button>
    <div class="forgot" id="forgot-password">Forgot password? Reset password</div>
    <div class="switch" id="switch-form">Don't have an account? Sign up</div>
  </div>

  <script>
    const apiBaseNew = "https://new-user-tunnel.fe-web.eu";
    const apiBaseUser = "https://user-tunnel.fe-web.eu";

    let currentLang = 'en_UK';
    let translations = {};
    let isLogin = true;

    // Caricamento traduzioni dai file JSON
    async function loadTranslations(lang) {
      try {
        const response = await fetch(`lang/${lang}.json`);
        if (!response.ok) throw new Error((getTranslation("int.error.loading") || "Loaging error:") + lang);
        translations = await response.json();
        updatePageTranslations();
      } catch (error) {
        console.error('Errore caricamento traduzioni:', error);
      }
    }

    function getTranslation(key) {
      return translations[key] || key;
    }

    function updatePageTranslations() {
      // Aggiorna titolo form
      const formTitle = document.getElementById('form-title');
      if (formTitle) {
        formTitle.textContent = isLogin ? getTranslation('int.login') : getTranslation('int.registration');
      }

      // Aggiorna placeholder
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      if (usernameInput) usernameInput.placeholder = getTranslation('int.username');
      if (passwordInput) passwordInput.placeholder = getTranslation('int.password');

      // Aggiorna bottone
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.textContent = isLogin ? getTranslation('int.signin') : getTranslation('int.create.account');
      }

      // Aggiorna link
      const forgotPassword = document.getElementById('forgot-password');
      const switchForm = document.getElementById('switch-form');
      if (forgotPassword) forgotPassword.textContent = getTranslation('int.forgot.password');
      if (switchForm) {
        switchForm.textContent = isLogin ? getTranslation('int.no.account') : getTranslation('int.have.account');
      }
    }

    // Cambio lingua
    document.getElementById('languageSelector').addEventListener('change', (e) => {
      currentLang = e.target.value;
      loadTranslations(currentLang);
    });

    // Carica lingua di default
    loadTranslations(currentLang);

    async function checkHealth() {
      try {
        const resUser = await fetch(`${apiBaseUser}/health`, { cache: "no-cache" });
        const resNew = await fetch(`${apiBaseNew}/health`, { cache: "no-cache" });
        if (!resUser.ok || !resNew.ok) throw new Error("HTTP error");
        const dataUser = await resUser.json();
        const dataNew = await resNew.json();
        if (dataUser.status !== "ok" || dataNew.status !== "ok") throw new Error("Service not OK");
      } catch (err) {
        document.body.innerHTML = `
        <div style="display:flex;justify-content:center;align-items:center;height:100vh;">
          <img src="images/off-line.jpeg" alt="Offline" class="offline">
        </div>
      `;
        console.error("Service check failed:", err);
      }
    }
    checkHealth();

    // === LOGIN / REGISTRAZIONE SWITCH ===
    const switchForm = document.getElementById("switch-form");

    switchForm.addEventListener("click", () => {
      isLogin = !isLogin;
      updatePageTranslations();
      document.getElementById("forgot-password").style.display = isLogin ? "block" : "none";
    });

    // === LOGIN / REGISTER ===
    document.getElementById('submit-btn').addEventListener("click", async () => {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!username || !password) {
        alert(getTranslation("int.complete.all.fields") || "Please fill in all fields");
        return;
      }

      const apiUrl = isLogin ? `${apiBaseUser}/login` : `${apiBaseNew}/create`;
      const payload = { username, password, currentLang };

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const contentType = response.headers.get("content-type");
        let data = contentType && contentType.includes("application/json")
          ? await response.json()
          : null;

        if (response.ok) {
          if (isLogin) {
            if (data.info) {
              currentLang = data.info.language;
              document.getElementById('languageSelector').value = currentLang;
              await loadTranslations(currentLang);
            }
            
            if (data.info && (!data.info.email || !data.info.language || !data.info.currency)) {
              requestMissingInfo(data.info, username, password);
            } else {
              openDashboard(username, data.token);
            }
          } 
        } else {
          alert("Dati: " || data.info || " " + isLogin + " " + apiUrl + " " + payload)
          if (isLogin) {
            alert(getTranslation('int.login.failed') || "Login failed");
          } else {
            alert(getTranslation('int.creation.failed') || "Creazione failed");
          }
        }
      } catch (err) {
        alert(getTranslation('int.connection.error') || "Connection error: " + err);
      }
    });

    // === FORGOT PASSWORD ===
    document.getElementById("forgot-password").addEventListener("click", () => {
      const email = prompt(getTranslation('int.enter.email') || "Enter your email to reset password:");
      if (!email) return;
      alert(getTranslation('int.reset.email.sent') || "If this email is registered, you will receive a password reset link.");
    });

    // === UPDATE INFO E RITORNO AL LOGIN ===
    function requestMissingInfo(info, username, password) {
      const container = document.getElementById("app-container");
      container.innerHTML = `
        <h2>${getTranslation('int.complete.profile')}</h2>
        <div class="input-group">
          <i class="fa fa-envelope"></i>
          <input type="email" id="email" placeholder="${getTranslation('int.email')}" value="${info.email || ''}">
        </div>
        <div class="input-group">
          <i class="fa fa-language"></i>
          <select id="language">
            <option value="">${getTranslation('int.select.language')}</option>
            <option value="en_UK" ${info.language === 'en_UK' ? 'selected' : ''}>English</option>
            <option value="it_IT" ${info.language === 'it_IT' ? 'selected' : ''}>Italiano</option>
            <option value="fr_FR" ${info.language === 'fr_FR' ? 'selected' : ''}>FranÃ§ais</option>
          </select>
        </div>
        <div class="input-group">
          <i class="fa fa-coins"></i>
          <select id="currency">
            <option value="">${getTranslation('int.select.currency')}</option>
            <option value="EUR" ${info.currency === 'EUR' ? 'selected' : ''}>EUR</option>
            <option value="USD" ${info.currency === 'USD' ? 'selected' : ''}>USD</option>
            <option value="GBP" ${info.currency === 'GBP' ? 'selected' : ''}>GBP</option>
          </select>
        </div>
        <button id="save-info">${getTranslation('int.update')}</button>
      `;

      document.getElementById("save-info").addEventListener("click", async () => {
        const email = document.getElementById("email").value.trim();
        const language = document.getElementById("language").value.trim();
        const currency = document.getElementById("currency").value.trim();

        if (!email || !language || !currency) {
          alert(getTranslation('int.complete.all.fields') || "Please complete all fields.");
          return;
        }

        try {
          const response = await fetch(`${apiBaseUser}/update`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password, email, language, currency })
          });

          const data = await response.json();

          if (response.ok && data.status === "ok") {
            alert(getTranslation('int.info.saved') || "Information saved successfully! Please log in again.");
            window.location.href = "index.html";
          } else {
            alert((getTranslation("int.error.update") || "Update failed: ") + data.message );
          }
        } catch (err) {
          alert((getTranslation("int.error.saving") || "Error saving info: ") + err.message);
        }
      });
    }

    function openDashboard(username, token) {
      localStorage.setItem("username", username);
      localStorage.setItem("token", token);
      localStorage.setItem("language", currentLang); // Salva anche la lingua
      window.location.href = "dashboard.html";
    }
  </script>
</body>

</html>