<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Estimates 0.1 alfa</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap');

    :root {
      --bg-color: #f5f5f0;
      --text-color: #333;
      --accent-color: #000;
      --paper-bg: #fff;
      --shadow-color: rgba(0, 0, 0, 0.08);
      --border-color: #000;
      --error-color: #d32f2f;
    }

    body {
      font-family: 'Cormorant Garamond', 'Times New Roman', serif;
      background-color: var(--bg-color);
      background-image: url('images/background.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      color: var(--text-color);
    }

    .top-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }

    .close-button {
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 0;
      background: transparent;
      color: var(--text-color);
      cursor: pointer;
      font-family: 'Cormorant Garamond', serif;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .close-button:hover {
      background: #eee;
    }

    #languageCombo {
      padding: 8px 12px;
      border: none;
      border-bottom: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-color);
      cursor: pointer;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1rem;
      outline: none;
    }

    .container {
      background: var(--paper-bg);
      padding: 60px 50px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 20px var(--shadow-color);
      border-radius: 2px;
      width: 400px;
      text-align: center;
      position: relative;
    }

    .logo-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 25px;
      margin-bottom: 40px;
    }

    /* 3D Rotating Cube - Wireframe Style */
    .cube-scene {
      width: 60px;
      height: 60px;
      perspective: 400px;
    }

    .cube {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      animation: rotate-cube 12s infinite linear;
    }

    .cube-face {
      position: absolute;
      width: 60px;
      height: 60px;
      border: 1px solid #000;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      backface-visibility: visible;
    }

    .cube-face.front {
      transform: translateZ(30px);
    }

    .cube-face.back {
      transform: rotateY(180deg) translateZ(30px);
    }

    .cube-face.right {
      transform: rotateY(90deg) translateZ(30px);
    }

    .cube-face.left {
      transform: rotateY(-90deg) translateZ(30px);
    }

    .cube-face.top {
      transform: rotateX(90deg) translateZ(30px);
    }

    .cube-face.bottom {
      transform: rotateX(-90deg) translateZ(30px);
    }

    @keyframes rotate-cube {
      0% {
        transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg);
      }

      100% {
        transform: rotateX(360deg) rotateY(360deg) rotateZ(0deg);
      }
    }

    .tron-text {
      text-align: left;
      font-family: 'Cormorant Garamond', serif;
      line-height: 1;
      border-left: 1px solid #000;
      padding-left: 15px;
    }

    .tron-text div:first-child {
      font-size: 1.4rem;
      font-weight: bold;
      color: #000;
      letter-spacing: 1px;
    }

    .tron-text div:last-child {
      font-size: 1.2rem;
      color: #555;
      font-style: italic;
      letter-spacing: 0.5px;
    }

    h2 {
      margin-bottom: 35px;
      color: #000;
      text-transform: uppercase;
      font-size: 1.3rem;
      letter-spacing: 2px;
      font-weight: normal;
      border-bottom: 1px solid #ddd;
      padding-bottom: 15px;
    }

    .input-group {
      position: relative;
      margin-bottom: 30px;
      text-align: left;
    }

    .input-group i {
      position: absolute;
      top: 10px;
      left: 0;
      color: #000;
      font-size: 0.9rem;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 8px 0 8px 25px;
      background: transparent;
      border: none;
      border-bottom: 1px solid #999;
      color: var(--text-color);
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      border-radius: 0;
      transition: border-color 0.3s;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-bottom: 1px solid #000;
    }

    .input-group input::placeholder {
      font-style: italic;
      color: #999;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      background: #000;
      color: #fff;
      font-size: 1rem;
      font-family: 'Cormorant Garamond', serif;
      border-radius: 0;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 10px;
    }

    button:hover {
      background: #333;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .switch,
    .forgot {
      text-align: center;
      margin-top: 25px;
      font-size: 0.95rem;
      color: #666;
      cursor: pointer;
      transition: color 0.2s;
      font-style: italic;
    }

    .forgot:hover,
    .switch:hover {
      color: #000;
      text-decoration: underline;
    }

    .offline {
      width: 300px;
      border-radius: 4px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      border: 1px solid #ddd;
    }
  </style>
</head>

<body>
  <div class="top-controls">
    <!--
    <button class="close-button" id="closeButton">
      <i class="fa fa-times"></i>
      <span id="closeText">Close</span>
    </button>
  -->
    <select id="languageCombo">
      <option value="" id="loadingOption">Loading...</option>
    </select>
  </div>

  <div class="container" id="app-container">
    <div class="logo-header">
      <div class="cube-scene">
        <div class="cube">
          <div class="cube-face front"></div>
          <div class="cube-face back"></div>
          <div class="cube-face right"></div>
          <div class="cube-face left"></div>
          <div class="cube-face top"></div>
          <div class="cube-face bottom"></div>
        </div>
      </div>
      <div class="tron-text">
        <div id="logo-financial">FINANCIAL</div>
        <div id="logo-estimates">ESTIMATES</div>
      </div>
    </div>
    <h2 id="form-title">Login</h2>

    <div class="input-group">
      <i class="fa fa-user"></i>
      <input type="text" id="username" placeholder="Username" pattern="[a-z0-9]+"
        oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9]/g, '')" autocomplete="username">
    </div>
    <div class="input-group">
      <i class="fa fa-lock"></i>
      <input type="password" id="password" placeholder="Password">
    </div>

    <button id="submit-btn">Sign in</button>
    <div class="forgot" id="forgot-password">Forgot password? Reset password</div>
    <div class="switch" id="switch-form">Don't have an account? Sign up</div>
  </div>

  <script>
    const apiBaseNew = "https://new-user-tunnel.fe-web.eu";
    const apiBaseUser = "https://user-tunnel.fe-web.eu";

    let language = 'en_UK'; // Lingua di default
    let translations = {};
    let currencies = [];
    let timezones = [];
    let availableLanguages = [];
    let isLogin = true;

    console.log("=== FinEst Login v0.31 ===");
    console.log("üåç Default language:", language);

    // ========== CLOSE BUTTON ==========
    //document.getElementById('closeButton').addEventListener('click', () => {

    // Se √® una PWA pu√≤ chiudere davvero
    //  if (window.matchMedia('(display-mode: standalone)').matches) {
    //    window.close();
    //    return;
    // }

    // Se esiste una pagina precedente, torna indietro
    //  if (history.length > 1) {
    //    history.back();
    //    return;
    // }

    // Fallback universale per mobile
    //  window.location.href = "about:blank";
    //});

    // ========== LANGUAGE SYSTEM ==========

    // Leggi l'elenco delle lingue dal manifest
    async function loadLanguageManifest() {
      console.log("üìã Loading language manifest...");
      try {
        const response = await fetch('lang/manifest.json');
        if (!response.ok) {
          console.error("Cannot load manifest.json");
          return [];
        }

        const manifest = await response.json();
        console.log("‚úÖ Manifest loaded:", manifest.languages);
        return manifest.languages || [];
      } catch (error) {
        console.error("Error loading manifest:", error);
        return [];
      }
    }

    // Carica un singolo file di lingua
    async function loadLanguageFile(langCode) {
      try {
        const response = await fetch(`lang/${langCode}.json`);
        if (!response.ok) {
          console.warn(`File not found: lang/${langCode}.json`);
          return null;
        }

        const data = await response.json();

        if (data['int.language.code'] && data['int.language.description'] && data['img.language.flag']) {
          return {
            code: data['int.language.code'],
            description: data['int.language.description'],
            flag: data['img.language.flag']
          };
        } else {
          console.warn(`Invalid structure in ${langCode}.json`);
          return null;
        }
      } catch (error) {
        console.error(`Error loading ${langCode}.json:`, error);
        return null;
      }
    }

    // Inizializza le lingue
    async function initializeLanguages() {
      console.log("üåç Initializing languages...");

      const langCodes = await loadLanguageManifest();

      for (const langCode of langCodes) {
        const langData = await loadLanguageFile(langCode);
        if (langData) {
          availableLanguages.push(langData);
          console.log(`‚úÖ Language loaded: ${langData.code}`);
        }
      }

      // Mantieni l'ordine dal manifest (non ordinare alfabeticamente)
      console.log("‚úÖ Languages initialized:", availableLanguages.length);
    }

    // Aggiorna combobox lingue
    function updateLanguageCombo() {
      const combo = document.getElementById('languageCombo');
      combo.innerHTML = '';

      if (availableLanguages.length === 0) {
        console.warn("No languages available");
        combo.innerHTML = '<option value="">No languages</option>';
        return;
      }

      availableLanguages.forEach(lang => {
        const option = document.createElement('option');
        option.value = lang.code;
        option.textContent = `${lang.flag} ${lang.description}`;
        if (lang.code === language) {
          option.selected = true;
        }
        combo.appendChild(option);
      });

      console.log("‚úÖ Language combo updated. Selected:", language);
    }

    // Carica traduzioni
    async function loadTranslations(lang) {
      console.log("üìö Loading translations for:", lang);
      try {
        const response = await fetch(`lang/${lang}.json`);
        if (!response.ok) throw new Error(`Translation file not found lang/${lang}.json`);
        translations = await response.json();
        console.log("‚úÖ Translations loaded for", lang);

        await loadCurrencies(lang);
        await loadTimezones();
      } catch (error) {
        console.error('‚ùå Error loading translations:', error);
      }
    }

    // Carica valute
    async function loadCurrencies(lang) {
      try {
        const response = await fetch(`currency/${lang}.json`);
        if (!response.ok) throw new Error(`Currency file not found currency/${lang}.json`);
        currencies = await response.json();
        console.log("‚úÖ Currencies loaded:", currencies.length);
      } catch (error) {
        console.error('‚ùå Error loading currencies:', error);
        currencies = [];
      }
    }

    // Carica timezone
    async function loadTimezones() {
      try {
        const response = await fetch(`timezone/timezone.json`);
        if (!response.ok) throw new Error("Timezone file not found");
        timezones = await response.json();
        console.log("‚úÖ Timezones loaded:", timezones.length);
      } catch (error) {
        console.error('‚ùå Error loading timezones:', error);
        timezones = [];
      }
    }

    // Ottieni traduzione
    function getTranslation(key) {
      return translations[key] || key;
    }

    // Aggiorna traduzioni pagina
    function updatePageTranslations() {
      console.log("üîÑ Updating page translations for language:", language);

      // Update close button text
      const closeText = document.getElementById('closeText');
      if (closeText) {
        closeText.textContent = getTranslation('int.close');
      }

      const formTitle = document.getElementById('form-title');
      if (formTitle) {
        formTitle.textContent = isLogin ? getTranslation('int.login') : getTranslation('int.registration');
      }

      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      if (usernameInput) {
        usernameInput.placeholder = getTranslation('int.username');
        usernameInput.title = getTranslation('int.username.validation');
      }
      if (passwordInput) passwordInput.placeholder = getTranslation('int.password');

      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.textContent = isLogin ? getTranslation('int.signin') : getTranslation('int.create.account');
      }

      const forgotPassword = document.getElementById('forgot-password');
      const switchForm = document.getElementById('switch-form');
      if (forgotPassword) forgotPassword.textContent = getTranslation('int.forgot.password');
      if (switchForm) switchForm.textContent = isLogin ? getTranslation('int.no.account') : getTranslation('int.have.account');

      const logoFinancial = document.getElementById('logo-financial');
      const logoEstimates = document.getElementById('logo-estimates');
      if (logoFinancial) logoFinancial.textContent = getTranslation('int.logo.financial');
      if (logoEstimates) logoEstimates.textContent = getTranslation('int.logo.estimates');

      const loadingOption = document.getElementById('loadingOption');
      if (loadingOption) loadingOption.textContent = getTranslation('int.loading');

      console.log("‚úÖ Page translations updated");
    }

    // Cambia lingua
    async function changeLanguage(langCode) {
      console.log("üåç Changing language from", language, "to", langCode);

      language = langCode;

      // Carica SEMPRE le traduzioni, anche se √® la stessa lingua
      await loadTranslations(langCode);
      updateLanguageCombo();
      updatePageTranslations();

      console.log("‚úÖ Language changed successfully to", langCode);
    }

    // Event listener per combobox lingue - usa 'input' per catturare anche i clic sulla stessa opzione
    document.getElementById('languageCombo').addEventListener('input', async (e) => {
      const selectedLang = e.target.value;
      console.log("üîç Language selector changed to:", selectedLang);

      if (selectedLang) {
        await changeLanguage(selectedLang);
      }
    });

    // Fallback con 'click' per assicurare che catturi sempre la selezione
    document.getElementById('languageCombo').addEventListener('click', async (e) => {
      const selectedLang = e.target.value;
      setTimeout(async () => {
        if (selectedLang && selectedLang !== language) {
          await changeLanguage(selectedLang);
        }
      }, 10);
    });

    // ========== LOGIN/REGISTRATION LOGIC ==========

    // Switch login/registration
    document.getElementById("switch-form").addEventListener("click", () => {
      isLogin = !isLogin;
      updatePageTranslations();
      document.getElementById("forgot-password").style.display = isLogin ? "block" : "none";
    });

    // Health check
    async function checkHealth() {
      try {
        const resUser = await fetch(`${apiBaseUser}/health`, { cache: "no-cache" });
        const resNew = await fetch(`${apiBaseNew}/health`, { cache: "no-cache" });

        if (!resUser.ok || !resNew.ok) throw new Error(getTranslation('int.services.unavailable') || "Services unavailable");
        console.log("‚úÖ " + (getTranslation('int.services.healthy') || "Services healthy"));
      } catch (err) {
        console.error("‚ùå " + (getTranslation('int.service.check.failed') || "Service check failed") + ":", err);
        document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;"><img src="images/off-line.jpeg" alt="Offline" class="offline"></div>';
      }
    }

    // Submit
    document.getElementById('submit-btn').addEventListener("click", async () => {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!username || !password) {
        alert(getTranslation("int.complete.all.fields") || "Please fill in all fields");
        return;
      }

      const apiUrl = isLogin ? `${apiBaseUser}/login` : `${apiBaseNew}/create`;
      const payload = { username, password, language };

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          mode: "cors",
          credentials: "omit",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify(payload)
        });

        const contentType = response.headers.get("content-type");
        let data;
        if (contentType && contentType.includes("application/json")) {
          data = await response.json();
        } else {
          data = await response.text();
        }

        if (response.ok) {
          if (isLogin) {
            await loadTranslations(data.language || language);
            if (data.info && (!data.info.email || !data.info.language || !data.info.timezone || !data.info.currency)) {
              requestMissingInfo(data.info, username, password);
            } else {
              openDashboard(username, data.token, data.language, data.currency);
            }
          } else {
            alert(getTranslation('int.creation.success') || "Account created successfully!");
            isLogin = true;
            updatePageTranslations();
            document.getElementById("username").value = username;
            document.getElementById("password").value = "";
          }
        } else {
          alert(isLogin ? getTranslation('int.login.failed') : getTranslation('int.creation.failed'));
        }
      } catch (err) {
        alert((getTranslation('int.connection.error') || "Connection error") + ": " + err.message);
      }
    });

    // Forgot password
    document.getElementById("forgot-password").addEventListener("click", () => {
      const email = prompt(getTranslation('int.enter.email') || "Enter your email:");
      if (email) alert(getTranslation('int.reset.email.sent') || "Email sent!");
    });

    // Richiesta info mancanti
    function requestMissingInfo(info, username, password) {
      document.querySelector('.top-controls').style.display = 'none';

      const container = document.getElementById("app-container");

      let currencyOptions = `<option value="">${getTranslation('int.select.currency')}</option>`;
      currencies.forEach(curr => {
        currencyOptions += `<option value="${curr.currency}">${curr['img.currency.flag']} ${curr.currency} - ${curr.description}</option>`;
      });

      let timezoneOptions = `<option value="">${getTranslation('int.select.timezone')}</option>`;
      timezones.forEach(tz => {
        timezoneOptions += `<option value="${tz.timezone}">${tz.timezone} (GMT${tz.offset_from_gmt}) - ${tz.reference_city}</option>`;
      });

      let languageOptions = `<option value="">${getTranslation('int.select.language')}</option>`;
      availableLanguages.forEach(lang => {
        languageOptions += `<option value="${lang.code}">${lang.flag} ${lang.description}</option>`;
      });

      container.innerHTML = `
        <h2>${getTranslation('int.complete.profile')}</h2>
        <div class="input-group">
          <i class="fa fa-envelope"></i>
          <input type="email" id="email" placeholder="${getTranslation('int.email')}" value="${info.email || ''}">
        </div>
        <div class="input-group">
          <i class="fa fa-language"></i>
          <select id="language">${languageOptions}</select>
        </div>
        <div class="input-group">
          <i class="fa fa-clock"></i>
          <select id="timezone">${timezoneOptions}</select>
        </div>
        <div class="input-group">
          <i class="fa fa-coins"></i>
          <select id="currency">${currencyOptions}</select>
        </div>
        <button id="save-info">${getTranslation('int.update')}</button>
      `;

      document.getElementById("save-info").addEventListener("click", async () => {
        const email = document.getElementById("email").value.trim();
        const lang = document.getElementById("language").value.trim();
        const currency = document.getElementById("currency").value.trim();
        const tz = document.getElementById("timezone").value.trim();

        if (!email || !lang || !currency || !tz) {
          alert(getTranslation('int.complete.all.fields'));
          return;
        }

        try {
          const response = await fetch(`${apiBaseUser}/update`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password, email, language: lang, currency, timezone: tz })
          });

          const data = await response.json();
          if (response.ok && data.status === "ok") {
            alert(getTranslation('int.info.saved'));
            document.querySelector('.top-controls').style.display = 'flex';
            window.location.href = "login.html";
          } else {
            alert(getTranslation("int.error.update"));
          }
        } catch (err) {
          alert(getTranslation("int.error.saving"));
        }
      });
    }

    // Apertura dashboard
    function openDashboard(username, token, lang, currency) {
      localStorage.setItem("username", username);
      localStorage.setItem("token", token);
      localStorage.setItem("language", lang);
      if (currency) localStorage.setItem("currency", currency);
      window.location.href = "dashboard.html";
    }

    // ========== INITIALIZATION ==========
    async function init() {
      console.log("üöÄ Initializing application...");

      // 0. Controlla se c'√® una lingua salvata da index.html
      const savedLanguage = localStorage.getItem('selectedLanguage');
      if (savedLanguage) {
        language = savedLanguage;
        console.log("üåç Using saved language from index.html:", language);
      }

      // 1. Inizializza le lingue disponibili
      await initializeLanguages();

      // 2. Carica le traduzioni per la lingua di default
      await loadTranslations(language);

      // 3. Aggiorna il combo per mostrare la lingua di default selezionata
      updateLanguageCombo();

      // 4. Traduci la pagina
      updatePageTranslations();

      // 5. Health check
      checkHealth();

      console.log("‚úÖ Application initialized successfully");
    }

    init();
  </script>
</body>

</html>