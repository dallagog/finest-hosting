<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Data Entry 1.0 beta</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap');

        :root {
            --bg-color: #050505;
            --neon-cyan: #00f3ff;
            --neon-blue: #0066ff;
            --glass-bg: rgba(0, 20, 40, 0.85);
            --text-color: #e0f7fa;
            --border-color: var(--neon-cyan);
            --error-color: #ff3333;
            --success-color: #00ff00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--bg-color);
            background-image:
                linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            padding: 20px;
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--glass-bg);
            border: 1px solid var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 102, 255, 0.3);
            border-radius: 8px;
            padding: 40px;
        }

        h1 {
            text-align: center;
            margin: 0 0 10px 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--neon-cyan);
            color: #fff;
            font-size: 2rem;
        }

        .subtitle {
            text-align: center;
            color: var(--neon-cyan);
            margin-bottom: 30px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dataentry-form {
            width: 100%;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        /* 2. Etichette non maiuscole - rimosso text-transform: uppercase */
        .form-label {
            font-weight: 500;
            color: var(--neon-blue);
            margin-bottom: 6px;
            font-size: 0.9rem;
            /* text-transform: uppercase; <--- Rimosso */
        }

        .required-mark {
            color: var(--error-color);
            margin-left: 4px;
            text-shadow: 0 0 5px var(--error-color);
        }

        /* 3. Altezza ridotta per input/select (30px) */
        .form-input,
        .form-select {
            padding: 6px 12px;
            background: rgba(0, 243, 255, 0.1);
            border: 1px solid var(--neon-blue);
            border-radius: 4px;
            font-size: 0.95rem;
            font-family: 'Orbitron', sans-serif;
            color: var(--text-color);
            transition: all 0.3s;
            height: 30px;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px var(--neon-cyan);
            background: rgba(0, 243, 255, 0.15);
        }

        .form-input.error,
        .form-select.error {
            border-color: var(--error-color);
            box-shadow: 0 0 5px var(--error-color);
        }

        /* Style per select con datalist combo */
        .combo-wrapper {
            position: relative;
        }

        .combo-input {
            width: 100%;
        }

        /* 4. Style per campo valuta (FE_Decimal) */
        .currency-input-group {
            display: flex;
            border: 1px solid var(--neon-blue);
            border-radius: 4px;
            overflow: hidden;
        }

        .currency-input-group:focus-within {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        /* Input field inside currency group */
        .currency-input-group .form-input {
            flex-grow: 1;
            border: none;
            background: rgba(0, 243, 255, 0.1);
            border-radius: 0;
            padding: 6px 12px;
            height: 30px;
        }

        /* Currency suffix (":€") */
        .currency-suffix {
            background: rgba(0, 102, 255, 0.2);
            color: var(--neon-cyan);
            padding: 6px 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            height: 30px;
            /* Border-left per separare visualmente input e suffisso */
            border-left: 1px solid var(--neon-blue);
        }

        /* Reset focus on inner input to avoid double shadow */
        .currency-input-group .form-input:focus {
            box-shadow: none;
            border-color: transparent;
            background: rgba(0, 243, 255, 0.15);
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.85rem;
            margin-top: 6px;
            min-height: 20px;
            text-shadow: 0 0 2px rgba(255, 0, 0, 0.5);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid var(--neon-blue);
        }

        .btn {
            padding: 10px 30px;
            font-family: 'Orbitron', sans-serif;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: rgba(0, 102, 255, 0.2);
            border: 1px solid var(--neon-blue);
            color: var(--neon-cyan);
        }

        .btn-primary:hover {
            background: var(--neon-blue);
            color: #fff;
            box-shadow: 0 0 20px var(--neon-blue);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #666;
            color: #ccc;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #999;
            color: #fff;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--neon-cyan);
        }

        .spinner {
            border: 3px solid rgba(0, 243, 255, 0.1);
            border-top: 3px solid var(--neon-cyan);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
            box-shadow: 0 0 15px var(--neon-cyan);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Success Message */
        .success-message {
            background: rgba(0, 255, 0, 0.15);
            border: 1px solid var(--success-color);
            color: var(--success-color);
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
            animation: fadeIn 0.5s ease-in-out;
        }

        .success-message.show {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--neon-blue);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-cyan);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1><i class="fa fa-chart-line"></i> Trade Data Entry</h1>
        <p class="subtitle">Inserisci i dati della transazione</p>

        <div id="success-msg" class="success-message">
            <i class="fa fa-check-circle"></i> Dati salvati con successo!
        </div>

        <div id="form-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Inizializzazione sistema...</p>
            </div>
        </div>
    </div>

    <script>
        // Parametri passati dall'URL
        let urlParams = {};

        // Recupera parametri URL
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            urlParams = {
                username: params.get('username') || '',
                token: params.get('token') || '',
                language: params.get('language') || 'it_IT',
                action: params.get('action') || '',
                type_event: params.get('type_event') || '',
                id_instrument: params.get('id_instrument') || '',
                id_account: params.get('id_account') || '',
                portfolio_data: params.get('portfolio_data') || '{}'
            };

            try {
                urlParams.portfolio_data_obj = JSON.parse(urlParams.portfolio_data);
            } catch (e) {
                urlParams.portfolio_data_obj = {};
            }
        }

        // Funzione mock per le traduzioni (traduzioni usate senza uppercase)
        function getTranslations(key) {
            const translations = {
                'int.id_account': 'Account',
                'int.type_event': 'Tipo Evento',
                'int.id_instrument': 'Strumento',
                'int.date_settlement': 'Data Regolamento',
                'int.date_trade': 'Data Trade',
                'int.quantity': 'Quantità',
                'int.exchange': 'Cambio',
                'int.price_divisor': 'Divisore Prezzo',
                'int.price': 'Prezzo',
                'int.cost:expense': 'Spese',
                'int.fee:commission': 'Commissioni',
                'int.tax:tobin': 'Tassa Tobin',
                'int.amount:gross': 'Importo Lordo',
                'int.amount:net': 'Importo Netto'
            };
            return translations[key] || key;
        }

        // Mock DataEntry Manager con supporto combobox editabili
        class DataEntryManager {
            constructor(config) {
                this.config = config;
                this.fields = [];
                this.values = {};
            }

            async init(containerId) {
                // Simula caricamento schema
                await new Promise(resolve => setTimeout(resolve, 500));

                // Definisci campi form
                this.fields = [
                    { name: 'id_account', label: 'int.id_account', type: 'combo', required: true, options: ['Account 1', 'Account 2', 'Trading'] },
                    { name: 'type_event', label: 'int.type_event', type: 'combo', required: true, options: ['FI-BB', 'FI-BA', 'FI-DIV'] },
                    { name: 'id_instrument', label: 'int.id_instrument', type: 'text', required: true },
                    { name: 'date_settlement', label: 'int.date_settlement', type: 'date', required: false },
                    { name: 'date_trade', label: 'int.date_trade', type: 'date', required: true },
                    { name: 'quantity', label: 'int.quantity', type: 'number', required: true },
                    { name: 'exchange', label: 'int.exchange', type: 'number', required: false },
                    { name: 'price_divisor', label: 'int.price_divisor', type: 'number', required: false },
                    { name: 'price', label: 'int.price', type: 'number', required: true },
                    { name: 'cost:expense', label: 'int.cost:expense', type: 'number', required: false },
                    { name: 'fee:commission', label: 'int.fee:commission', type: 'number', required: false },
                    { name: 'tax:tobin', label: 'int.tax:tobin', type: 'number', required: false },
                    { name: 'amount:gross', label: 'int.amount:gross', type: 'number', required: false },
                    { name: 'amount:net', label: 'int.amount:net', type: 'number', required: false }
                ];

                // Imposta valori di default
                this.values = { ...this.config.defaultValues };

                // Sovrascrive con parametri URL
                if (urlParams.id_account) this.values.id_account = urlParams.id_account;
                if (urlParams.type_event) this.values.type_event = urlParams.type_event;

                // 1. Modifica per id_instrument: prende solo il codice (prima parte)
                if (urlParams.id_instrument) {
                    // Assumiamo che il codice sia la prima parola o il testo prima di un separatore comune come '-'
                    let code = urlParams.id_instrument.split(' ')[0];
                    if (code.includes('-')) {
                        code = code.split('-')[0].trim();
                    }
                    this.values.id_instrument = code.trim();
                }

                this.render(containerId);
            }

            // Funzione helper per identificare i campi valuta
            isCurrencyField(fieldName) {
                return fieldName.includes('amount') || fieldName.includes('cost') || fieldName.includes('fee') || fieldName.includes('tax');
            }

            render(containerId) {
                const container = document.getElementById(containerId);

                const form = document.createElement('form');
                form.className = 'dataentry-form';

                const grid = document.createElement('div');
                grid.className = 'form-grid';

                this.fields.forEach(field => {
                    const group = document.createElement('div');
                    group.className = 'form-group';

                    const label = document.createElement('label');
                    label.className = 'form-label';
                    label.textContent = getTranslations(field.label); // Testo della label non in uppercase
                    if (field.required) {
                        const req = document.createElement('span');
                        req.className = 'required-mark';
                        req.textContent = '*';
                        label.appendChild(req);
                    }

                    let input; // L'elemento input HTML
                    let inputContainer = null; // Il container da appendere al group (input, combo-wrapper, o currency-input-group)

                    if (field.type === 'combo') {
                        // Combo Input (datalist)
                        const wrapper = document.createElement('div');
                        wrapper.className = 'combo-wrapper';

                        const datalistId = `${field.name}-datalist`;

                        input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'form-input combo-input';
                        input.name = field.name;
                        input.setAttribute('list', datalistId);
                        input.value = this.values[field.name] || '';

                        const datalist = document.createElement('datalist');
                        datalist.id = datalistId;
                        field.options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            datalist.appendChild(option);
                        });

                        wrapper.appendChild(input);
                        wrapper.appendChild(datalist);
                        inputContainer = wrapper;

                    } else if (this.isCurrencyField(field.name)) {
                        // 4. Input Valuta (FE_Decimal)
                        const wrapper = document.createElement('div');
                        wrapper.className = 'currency-input-group';

                        input = document.createElement('input');
                        input.type = field.type;
                        input.className = 'form-input';
                        input.name = field.name;
                        input.value = this.values[field.name] || '';

                        if (field.type === 'number') {
                            input.step = '0.01';
                        }

                        const suffix = document.createElement('div');
                        suffix.className = 'currency-suffix';
                        suffix.textContent = ': €'; // Formato richiesto

                        wrapper.appendChild(input);
                        wrapper.appendChild(suffix);
                        inputContainer = wrapper;

                    } else {
                        // Input Standard (text, number, date)
                        input = document.createElement('input');
                        input.type = field.type;
                        input.className = 'form-input';
                        input.name = field.name;
                        input.value = this.values[field.name] || '';

                        if (field.type === 'number') {
                            input.step = '0.01';
                        }
                        inputContainer = input;
                    }

                    group.appendChild(label);
                    group.appendChild(inputContainer);

                    if (field.required) {
                        input.required = true;
                    }

                    const error = document.createElement('div');
                    error.className = 'error-message';
                    group.appendChild(error);

                    // L'event listener è sempre sull'elemento input effettivo
                    input.addEventListener('change', (e) => {
                        this.values[field.name] = e.target.value;
                        if (this.config.onChange) {
                            this.config.onChange(field.name, e.target.value);
                        }
                    });

                    grid.appendChild(group);
                });

                form.appendChild(grid);

                const actions = document.createElement('div');
                actions.className = 'form-actions';

                const resetBtn = document.createElement('button');
                resetBtn.type = 'button';
                resetBtn.className = 'btn btn-secondary';
                resetBtn.innerHTML = '<i class="fa fa-undo"></i> Reset';
                resetBtn.onclick = () => {
                    form.reset();
                    this.values = { ...this.config.defaultValues };
                };

                const submitBtn = document.createElement('button');
                submitBtn.type = 'submit';
                submitBtn.className = 'btn btn-primary';
                submitBtn.innerHTML = '<i class="fa fa-save"></i> Salva';

                actions.appendChild(resetBtn);
                actions.appendChild(submitBtn);
                form.appendChild(actions);

                form.onsubmit = (e) => {
                    e.preventDefault();
                    if (this.config.onSubmit) {
                        this.config.onSubmit(this.values);
                    }
                };

                container.innerHTML = '';
                container.appendChild(form);
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async () => {
            getURLParams();

            // Valori di default
            const defaultValues = {
                price_divisor: '1',
                exchange: '1.00',
                'cost:expense': '0.00',
                'fee:commission': '0.00',
                'tax:tobin': '0.00'
            };

            const manager = new DataEntryManager({
                basePath: './dataentry/',
                folder: 'trade',
                defaultValues: defaultValues,
                onSubmit: (data) => {
                    console.log('Dati inviati:', data);

                    const successMsg = document.getElementById('success-msg');
                    successMsg.classList.add('show');

                    window.scrollTo({ top: 0, behavior: 'smooth' });

                    setTimeout(() => {
                        successMsg.classList.remove('show');
                    }, 3000);
                },
                onChange: (fieldName, value) => {
                    console.log(`Campo ${fieldName} modificato:`, value);
                }
            });

            try {
                await manager.init('form-container');
            } catch (error) {
                document.getElementById('form-container').innerHTML = `
                    <div class="auth-error" style="border-color: var(--error-color); color: var(--error-color);">
                        <h3><i class="fa fa-exclamation-triangle"></i> Errore Sistema</h3>
                        <p>Errore caricamento modulo: ${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.8rem; color: #ccc;">
                            Verificare la presenza dei file JSON nella cartella configurata.
                        </p>
                    </div>
                `;
            }
        });
    </script>
</body>

</html>