<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Entry System</title>
    <style>
        /* Stile LaTeX classico */
        body {
            font-family: "Computer Modern", "Latin Modern Roman", serif;
            max-width: 7in;
            margin: 1.5in auto;
            padding: 0 0.5in;
            background-color: #f9f9f5;
            color: #1a1a1a;
            line-height: 1.6;
        }

        h1 {
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            margin: 2em 0 1.5em 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .menu-container {
            background: white;
            padding: 2em;
            border: 1px solid #d0d0d0;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2em;
        }

        .menu-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 1.5em;
            border-bottom: 2px solid #1a1a1a;
            padding-bottom: 0.5em;
        }

        .menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-item {
            padding: 1em;
            margin-bottom: 0.5em;
            border: 1px solid #d0d0d0;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }

        .menu-item:hover {
            background: #1a1a1a;
            color: white;
            transform: translateX(5px);
        }

        .menu-item.active {
            background: #4a4a4a;
            color: white;
            border-color: #1a1a1a;
        }

        .menu-item-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 0.3em;
        }

        .menu-item-description {
            font-size: 0.9em;
            font-style: italic;
        }

        .form-container {
            background: white;
            padding: 2em;
            border: 1px solid #d0d0d0;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
        }

        .current-module {
            background: #e8f5e9;
            padding: 1em;
            margin-bottom: 1.5em;
            border-left: 4px solid #4caf50;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 1.5em;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.3em;
            font-size: 0.95em;
        }

        label .required {
            color: #c00;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"] {
            width: 100%;
            padding: 0.5em;
            border: 1px solid #888;
            background: #fafafa;
            font-family: "Courier New", monospace;
            font-size: 0.95em;
            box-sizing: border-box;
        }

        input:focus {
            outline: 2px solid #4a4a4a;
            background: white;
        }

        .error {
            color: #c00;
            font-size: 0.85em;
            margin-top: 0.3em;
            font-style: italic;
        }

        .button-group {
            display: flex;
            gap: 1em;
            margin-top: 2em;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 0.7em 2em;
            font-size: 1em;
            font-weight: bold;
            border: 2px solid #1a1a1a;
            background: white;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }

        button:hover:not(:disabled) {
            background: #1a1a1a;
            color: white;
        }

        button:active {
            transform: translateY(1px);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        button.delete {
            border-color: #c00;
            color: #c00;
        }

        button.delete:hover:not(:disabled) {
            background: #c00;
            color: white;
        }

        .json-editor {
            background: #f5f5f5;
            border: 1px solid #d0d0d0;
            padding: 1em;
            margin-top: 2em;
            font-family: "Courier New", monospace;
            font-size: 0.85em;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre;
            outline: none;
        }

        .json-editor:focus {
            background: white;
            border-color: #4a4a4a;
        }

        .status-message {
            padding: 1em;
            margin-top: 1em;
            border-left: 4px solid;
            font-weight: bold;
        }

        .status-message.success {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .status-message.error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        .status-message.info {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1565c0;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 2em;
            margin-bottom: 1em;
            border-bottom: 2px solid #1a1a1a;
            padding-bottom: 0.3em;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 2em;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Data Entry System</h1>

    <div class="menu-container">
        <div class="menu-title">Select Data Entry Module</div>
        <ul class="menu-list" id="menuList">
            <li class="loading">Loading menu...</li>
        </ul>
    </div>

    <div id="formContainer" class="hidden">
        <div class="current-module" id="currentModule"></div>
        
        <div class="form-container">
            <div id="dynamicForm"></div>

            <div class="button-group">
                <button type="button" onclick="addEntry()">Add</button>
                <button type="button" onclick="deleteData()" class="delete">Delete</button>
                <button type="button" onclick="commitData()">Commit</button>
            </div>

            <div id="status"></div>
        </div>

        <div class="section-title">JSON Data (Editable)</div>
        <div 
            class="json-editor" 
            id="jsonEditor" 
            contenteditable="true"
            spellcheck="false"
            onblur="updateFromEditor()">
        </div>
    </div>

    <script>
        let menuData = [];
        let currentPrefix = '';
        let currentModuleName = '';
        let mapping = {};
        let format = {};
        let required = [];
        let jsonData = null;
        let baseStructure = {};

        // Carica il menu all'avvio
        window.addEventListener('DOMContentLoaded', loadMenu);

        async function loadMenu() {
            try {
                const response = await fetch('menu.json');
                if (!response.ok) throw new Error('Impossibile caricare menu.json');
                
                const data = await response.json();
                menuData = data.menu.sort((a, b) => a.id.localeCompare(b.id));
                
                renderMenu();
            } catch (error) {
                document.getElementById('menuList').innerHTML = 
                    `<li class="error">Errore caricamento menu: ${error.message}</li>`;
            }
        }

        function renderMenu() {
            const menuList = document.getElementById('menuList');
            menuList.innerHTML = '';

            menuData.forEach(item => {
                const li = document.createElement('li');
                li.className = 'menu-item';
                li.onclick = () => selectModule(item);
                
                li.innerHTML = `
                    <div class="menu-item-title">${item.item}</div>
                    <div class="menu-item-description">${item.description}</div>
                `;
                
                menuList.appendChild(li);
            });
        }

        async function selectModule(item) {
            // Aggiorna UI menu
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            currentPrefix = item.link;
            currentModuleName = item.item;
            
            document.getElementById('currentModule').textContent = 
                `Current Module: ${currentModuleName} (${item.description})`;

            // Carica configurazione
            await loadConfiguration(currentPrefix);
        }

        async function loadConfiguration(prefix) {
            try {
                showStatus('Caricamento configurazione...', 'info');

                const configs = {
                    data: null,
                    format: null,
                    mandatory: null,
                    mapping: null
                };

                // Carica i file di configurazione
                const files = [
                    { suffix: '', key: 'data' },
                    { suffix: 'format', key: 'format' },
                    { suffix: 'mandatory', key: 'mandatory' },
                    { suffix: 'mapping', key: 'mapping' }
                ];

                for (const file of files) {
                    try {
                        const suffix = file.suffix ? `@${file.suffix}` : '';
                        const url = `items/${prefix}@data${suffix}.json`;
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            configs[file.key] = await response.json();
                        }
                    } catch (error) {
                        console.warn(`File ${file.key} non trovato o non valido`);
                    }
                }

                // Verifica che almeno il file data sia presente
                if (!configs.data) {
                    showStatus('File di configurazione principale non trovato', 'error');
                    return;
                }

                // Carica configurazioni
                baseStructure = configs.data;
                format = configs.format || {};
                required = configs.mandatory?.required || [];
                mapping = configs.mapping || {};

                // Se mapping Ã¨ vuoto, crealo dai dati
                if (Object.keys(mapping).length === 0 && baseStructure.data && baseStructure.data.length > 0) {
                    const firstEntry = baseStructure.data[0];
                    for (const key of Object.keys(firstEntry)) {
                        mapping[key] = {
                            label: key.charAt(0).toUpperCase() + key.slice(1),
                            mapped_name: key
                        };
                    }
                }

                // Inizializza dati
                jsonData = JSON.parse(JSON.stringify(baseStructure));
                if (!jsonData.data) {
                    jsonData.data = [];
                }

                // Crea form dinamico
                createDynamicForm();
                updateJsonEditor();
                document.getElementById('formContainer').classList.remove('hidden');
                showStatus('Configurazione caricata con successo', 'success');

            } catch (error) {
                showStatus(`Errore nel caricamento: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function createDynamicForm() {
            const formEl = document.getElementById('dynamicForm');
            formEl.innerHTML = '';

            // Estrai i campi dal mapping
            let fields = Object.keys(mapping);

            // Crea campi dinamicamente
            for (const fieldName of fields) {
                const fieldConfig = mapping[fieldName];
                const isRequired = required.includes(fieldName);
                const fieldFormat = format[fieldName] || {};

                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                const label = document.createElement('label');
                label.htmlFor = fieldName;
                label.innerHTML = fieldConfig.label + (isRequired ? ' <span class="required">*</span>' : '');

                const input = document.createElement('input');
                input.id = fieldName;
                input.name = fieldName;
                
                // Determina il tipo di input
                if (fieldFormat.type === 'date') {
                    input.type = 'date';
                } else if (fieldFormat.type === 'number') {
                    input.type = 'number';
                } else {
                    input.type = 'text';
                }

                if (isRequired) {
                    input.required = true;
                }

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.id = `error-${fieldName}`;

                formGroup.appendChild(label);
                formGroup.appendChild(input);
                formGroup.appendChild(errorDiv);
                formEl.appendChild(formGroup);

                // Aggiungi validazione
                input.addEventListener('blur', () => {
                    validateField(fieldName, input.value);
                });
            }
        }

        function validateField(fieldName, value) {
            const errorEl = document.getElementById(`error-${fieldName}`);
            if (!errorEl) return true;
            
            errorEl.textContent = '';

            // Verifica campi obbligatori
            if (required.includes(fieldName) && !value.trim()) {
                errorEl.textContent = 'Campo obbligatorio';
                return false;
            }

            // Verifica formato
            if (value && format[fieldName]) {
                if (format[fieldName].regex) {
                    const regex = new RegExp(format[fieldName].regex);
                    if (!regex.test(value)) {
                        errorEl.textContent = 'Formato non valido';
                        return false;
                    }
                }

                if (format[fieldName].type === 'date' && format[fieldName].format) {
                    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                    if (!dateRegex.test(value)) {
                        errorEl.textContent = `Formato data non valido (${format[fieldName].format})`;
                        return false;
                    }
                }
            }

            return true;
        }

        function validateAll() {
            let isValid = true;
            
            for (const fieldName of Object.keys(mapping)) {
                const input = document.getElementById(fieldName);
                if (input) {
                    const value = input.value;
                    if (!validateField(fieldName, value)) {
                        isValid = false;
                    }
                }
            }

            return isValid;
        }

        function clearForm() {
            for (const fieldName of Object.keys(mapping)) {
                const input = document.getElementById(fieldName);
                if (input) {
                    input.value = '';
                }
            }
            
            document.querySelectorAll('.error').forEach(el => el.textContent = '');
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status-message ${type}`;
            statusEl.textContent = message;
            
            if (type !== 'info') {
                setTimeout(() => {
                    statusEl.textContent = '';
                    statusEl.className = '';
                }, 3000);
            }
        }

        function updateJsonEditor() {
            document.getElementById('jsonEditor').textContent = 
                JSON.stringify(jsonData, null, 2);
        }

        function updateFromEditor() {
            try {
                const editorContent = document.getElementById('jsonEditor').textContent;
                const parsed = JSON.parse(editorContent);
                jsonData = parsed;
                showStatus('JSON aggiornato correttamente', 'success');
            } catch (error) {
                showStatus('Errore nel parsing JSON: ' + error.message, 'error');
                // Ripristina il JSON valido
                updateJsonEditor();
            }
        }

        function addEntry() {
            if (!validateAll()) {
                showStatus('Correggere gli errori nel form', 'error');
                return;
            }

            // Crea oggetto con i campi rimappati
            const entry = {};
            
            for (const [fieldName, config] of Object.entries(mapping)) {
                const input = document.getElementById(fieldName);
                if (input) {
                    const value = input.value;
                    
                    if (value || required.includes(fieldName)) {
                        entry[config.mapped_name] = value;
                    }
                }
            }

            // Aggiungi al JSON
            jsonData.data.push(entry);
            updateJsonEditor();
            clearForm();
            showStatus('Dati aggiunti con successo', 'success');
        }

        function deleteData() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati?')) {
                jsonData.data = [];
                updateJsonEditor();
                showStatus('Dati cancellati', 'info');
            }
        }

        async function commitData() {
            if (!jsonData || jsonData.data.length === 0) {
                showStatus('Nessun dato da committare', 'error');
                return;
            }

            // Aggiorna dai dati editati
            updateFromEditor();

            try {
                const endpoint = `/api/${currentPrefix}-data`;
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jsonData)
                });

                if (response.ok) {
                    showStatus('Dati committati con successo al database', 'success');
                    jsonData.data = [];
                    updateJsonEditor();
                } else {
                    const error = await response.text();
                    showStatus(`Errore nel commit: ${error}`, 'error');
                }
            } catch (error) {
                showStatus(`Errore di connessione: ${error.message}`, 'error');
                console.error('Errore commit:', error);
            }
        }
    </script>
</body>
</html>
